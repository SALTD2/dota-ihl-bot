

<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>JSDoc: lib/db.js</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link href="https://fonts.googleapis.com/css?family=Muli:100,400,700|Oswald:300|Inconsolata,700" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
    <link type="text/css" rel="stylesheet" href="https://jmblog.github.io/color-themes-for-google-code-prettify/themes/tomorrow-night.min.css">
    <link type="text/css" rel="stylesheet" href="styles/app.min.css">
</head>

<body>
    <div id="stickyNavbarOverlay"></div>
    <div class="top-navbar">
        <div class="container">
            <nav class="navbar" role="navigation" aria-label="main navigation">
                <div class="navbar-brand">
                     
                        <div><a href="index.html"><img class="logo-image" src="img/logo.png" alt="logo"></a></div>
                    
                     
                        <h1 class="navbar-item"><a href="index.html">dota-ihl-bot Documentation</a></h1>
                    
                    <a id="hamburger" role="button" class="navbar-burger" aria-label="menu" aria-expanded="false">
                        <span aria-hidden="true"></span>
                        <span aria-hidden="true"></span>
                        <span aria-hidden="true"></span>
                    </a>
                </div>
                <div class="navbar-menu">
                    <div class="navbar-end">
                        <div class="navbar-item">
                            <div id="search-container" class="search-container">
                                <input type="text" placeholder="Search" />
                                <ul></ul>
                            </div>
                        </div>
                     
                    
                        <div class="navbar-item">
                            <a href="https://github.com/devilesk/dota-ihl-bot" target="_blank">Github</a>
                        </div>
                    
                    
                    </div>
                </div>
            </nav>
        </div>
    </div>
    <div class="container">
        <div class="columns">
            <div class="column is-3" id="sidebarNav">
                <div class="sidebar">
                    <nav>
                        <h2><a href="index.html">Home</a></h2><div class="category"><h3>Modules</h3><ul><li><a href="module-constants.html">constants</a></li><li><a href="module-db.html">db</a></li><li><a href="module-dotaBot.html">dotaBot</a></li><li><a href="module-fp.html">fp</a></li><li><a href="module-guild.html">guild</a></li><li><a href="module-ihl.html">ihl</a></li><li><a href="module-ihlCommand.html">ihlCommand</a></li><li><a href="module-ihlManager.html">ihlManager</a></li><li><a href="module-lobby.html">lobby</a></li><li><a href="module-matchTracker.html">matchTracker</a></li><li><a href="module-rankTier.html">rankTier</a></li><li><a href="module-util.html">util</a></li></ul><h3>Classes</h3><ul><li><a href="module-db.Database.html">Database</a></li><li><a href="module-dotaBot-DotaBot.html">DotaBot</a></li><li><a href="module-ihlCommand-IHLCommand.html">IHLCommand</a></li><li><a href="module-ihlManager-IHLManager.html">IHLManager</a></li><li><a href="module-matchTracker-MatchTracker.html">MatchTracker</a></li><li><a href="module-util.Queue.html">Queue</a></li></ul><h3>Events</h3><ul><li><a href="module-ihlManager.html#~event:empty">empty</a></li><li><a href="module-ihlManager.html#~event:EVENT_MATCH_STATS">EVENT_MATCH_STATS</a></li><li><a href="module-ihlManager.html#~event:ready">ready</a></li></ul><h3>Mixins</h3><ul><li><a href="module-ihlManager.EventListeners.html">EventListeners</a></li><li><a href="module-ihlManager.LobbyQueueHandlers.html">LobbyQueueHandlers</a></li><li><a href="module-ihlManager.LobbyStateHandlers.html">LobbyStateHandlers</a></li></ul></div><div class="category"><h2>Commands</h2><h3>Classes</h3><ul><li><a href="module-ihlCommand.BotAddCommand.html">BotAddCommand</a></li><li><a href="module-ihlCommand.BotListCommand.html">BotListCommand</a></li><li><a href="module-ihlCommand.BotRemoveCommand.html">BotRemoveCommand</a></li><li><a href="module-ihlCommand.BotStatusCommand.html">BotStatusCommand</a></li><li><a href="module-ihlCommand.ChallengeCommand.html">ChallengeCommand</a></li><li><a href="module-ihlCommand.ChallengeListCommand.html">ChallengeListCommand</a></li><li><a href="module-ihlCommand.CommendCommand.html">CommendCommand</a></li><li><a href="module-ihlCommand.DireCommand.html">DireCommand</a></li><li><a href="module-ihlCommand.DumpMembersCommand.html">DumpMembersCommand</a></li><li><a href="module-ihlCommand.FirstCommand.html">FirstCommand</a></li><li><a href="module-ihlCommand.GameModeCommand.html">GameModeCommand</a></li><li><a href="module-ihlCommand.InviteCommand.html">InviteCommand</a></li><li><a href="module-ihlCommand.InviteUrlCommand.html">InviteUrlCommand</a></li><li><a href="module-ihlCommand.LeaderboardCommand.html">LeaderboardCommand</a></li><li><a href="module-ihlCommand.LeagueCreateCommand.html">LeagueCreateCommand</a></li><li><a href="module-ihlCommand.LeagueInfoCommand.html">LeagueInfoCommand</a></li><li><a href="module-ihlCommand.LeagueSeasonCommand.html">LeagueSeasonCommand</a></li><li><a href="module-ihlCommand.LeagueTicketCommand.html">LeagueTicketCommand</a></li><li><a href="module-ihlCommand.LeagueUpdateCommand.html">LeagueUpdateCommand</a></li><li><a href="module-ihlCommand.LobbyDraftCommand.html">LobbyDraftCommand</a></li><li><a href="module-ihlCommand.LobbyFirstPickCommand.html">LobbyFirstPickCommand</a></li><li><a href="module-ihlCommand.LobbyGameModeCommand.html">LobbyGameModeCommand</a></li><li><a href="module-ihlCommand.LobbyInviteCommand.html">LobbyInviteCommand</a></li><li><a href="module-ihlCommand.LobbyKickCommand.html">LobbyKickCommand</a></li><li><a href="module-ihlCommand.LobbyKillCommand.html">LobbyKillCommand</a></li><li><a href="module-ihlCommand.LobbyLeaveCommand.html">LobbyLeaveCommand</a></li><li><a href="module-ihlCommand.LobbyRunCommand.html">LobbyRunCommand</a></li><li><a href="module-ihlCommand.LobbyStartCommand.html">LobbyStartCommand</a></li><li><a href="module-ihlCommand.LobbyStateCommand.html">LobbyStateCommand</a></li><li><a href="module-ihlCommand.LobbySwapCommand.html">LobbySwapCommand</a></li><li><a href="module-ihlCommand.LogLevelCommand.html">LogLevelCommand</a></li><li><a href="module-ihlCommand.NicknameCommand.html">NicknameCommand</a></li><li><a href="module-ihlCommand.PickCommand.html">PickCommand</a></li><li><a href="module-ihlCommand.QueueBanCommand.html">QueueBanCommand</a></li><li><a href="module-ihlCommand.QueueClearCommand.html">QueueClearCommand</a></li><li><a href="module-ihlCommand.QueueJoinCommand.html">QueueJoinCommand</a></li><li><a href="module-ihlCommand.QueueLeaveCommand.html">QueueLeaveCommand</a></li><li><a href="module-ihlCommand.QueueReadyCommand.html">QueueReadyCommand</a></li><li><a href="module-ihlCommand.QueueStatusCommand.html">QueueStatusCommand</a></li><li><a href="module-ihlCommand.RadiantCommand.html">RadiantCommand</a></li><li><a href="module-ihlCommand.RegisterCommand.html">RegisterCommand</a></li><li><a href="module-ihlCommand.RepCommand.html">RepCommand</a></li><li><a href="module-ihlCommand.RestartCommand.html">RestartCommand</a></li><li><a href="module-ihlCommand.RolesCommand.html">RolesCommand</a></li><li><a href="module-ihlCommand.SecondCommand.html">SecondCommand</a></li><li><a href="module-ihlCommand.TicketAddCommand.html">TicketAddCommand</a></li><li><a href="module-ihlCommand.TicketRemoveCommand.html">TicketRemoveCommand</a></li><li><a href="module-ihlCommand.UnchallengeCommand.html">UnchallengeCommand</a></li><li><a href="module-ihlCommand.UncommendCommand.html">UncommendCommand</a></li><li><a href="module-ihlCommand.UnrepCommand.html">UnrepCommand</a></li><li><a href="module-ihlCommand.UserBadgeCommand.html">UserBadgeCommand</a></li><li><a href="module-ihlCommand.UserVouchCommand.html">UserVouchCommand</a></li><li><a href="module-ihlCommand.WhoisCommand.html">WhoisCommand</a></li></ul></div><div class="category"><h2>Database</h2><h3>Classes</h3><ul><li><a href="module-db.Bot.html">Bot</a></li><li><a href="module-db.BotTicket.html">BotTicket</a></li><li><a href="module-db.Challenge.html">Challenge</a></li><li><a href="module-db.Commend.html">Commend</a></li><li><a href="module-db.Leaderboard.html">Leaderboard</a></li><li><a href="module-db.League.html">League</a></li><li><a href="module-db.LeagueTicket.html">LeagueTicket</a></li><li><a href="module-db.Lobby.html">Lobby</a></li><li><a href="module-db.LobbyPlayer.html">LobbyPlayer</a></li><li><a href="module-db.LobbyQueuer.html">LobbyQueuer</a></li><li><a href="module-db.Queue.html">Queue</a></li><li><a href="module-db.Reputation.html">Reputation</a></li><li><a href="module-db.Season.html">Season</a></li><li><a href="module-db.Ticket.html">Ticket</a></li><li><a href="module-db.User.html">User</a></li></ul></div><div class="category"><h2>Other</h2><h3>Externals</h3><ul><li><a href="external-commando.html">commando</a></li><li><a href="external-EventEmitter.html">EventEmitter</a></li><li><a href="external-Long.html">Long</a></li></ul></div><div class="category"><h2>Sequelize</h2><h3>Externals</h3><ul><li><a href="external-sequelize.html">sequelize</a></li></ul><h3>Classes</h3><ul><li><a href="external-sequelize.Model.html">Model</a></li></ul></div><div class="category"><h2>discord.js</h2><h3>Externals</h3><ul><li><a href="external-discordjs.html">discordjs</a></li></ul><h3>Classes</h3><ul><li><a href="external-discordjs.CategoryChannel.html">CategoryChannel</a></li><li><a href="external-discordjs.Client.html">Client</a></li><li><a href="external-discordjs.Guild.html">Guild</a></li><li><a href="external-discordjs.GuildChannel.html">GuildChannel</a></li><li><a href="external-discordjs.GuildMember.html">GuildMember</a></li><li><a href="external-discordjs.Message.html">Message</a></li><li><a href="external-discordjs.Role.html">Role</a></li><li><a href="external-discordjs.User.html">User</a></li></ul></div><div class="category"><h2>node-dota2</h2><h3>Externals</h3><ul><li><a href="external-Dota2.html">Dota2</a></li></ul><h3>Classes</h3><ul><li><a href="external-Dota2.Dota2Client.html">Dota2Client</a></li></ul></div><div class="category"><h2>node-steam</h2><h3>Externals</h3><ul><li><a href="external-steam.html">steam</a></li></ul><h3>Classes</h3><ul><li><a href="external-steam.SteamClient.html">SteamClient</a></li><li><a href="external-steam.SteamFriends.html">SteamFriends</a></li><li><a href="external-steam.SteamUser.html">SteamUser</a></li></ul></div>
                    </nav>
                </div>
            </div>
            <div class="column is-9-desktop">
                <div class="content" id="main-content-wrapper">
                    <header class="page-title">
                        <p>Source</p>
                        <h1>lib/db.js</h1>
                    </header>
                    
                    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @module db
 * @description Database functions
 */

/**
 * External namespace for discord.js classes.
 * @external sequelize
 * @category Sequelize
 * @see {@link http://docs.sequelizejs.com/}
 */

/**
 * External Sequelize Model class.
 * @class Model
 * @category Sequelize
 * @memberof external:sequelize
 * @see {@link http://docs.sequelizejs.com/class/lib/model.js~Model.html}
 */

const Sequelize = require('sequelize');
const logger = require('./logger');
const Fp = require('./util/fp');
const db = require('../models');
const CONSTANTS = require('./constants');
const { hri } = require('human-readable-ids');

const { Op } = Sequelize;

const findAllLeagues = async () => db.League.findAll();

const findAllActiveLobbiesForInhouse = async guildId => db.Lobby.findAll({ where: { state: { [Op.notIn]: [CONSTANTS.STATE_COMPLETED, CONSTANTS.STATE_COMPLETED_NO_STATS, CONSTANTS.STATE_KILLED, CONSTANTS.STATE_FAILED] } }, include: [{ model: db.League, where: { guildId } }] });

const findAllActiveLobbies = async () => db.Lobby.findAll({ where: { state: { [Op.notIn]: [CONSTANTS.STATE_COMPLETED, CONSTANTS.STATE_COMPLETED_NO_STATS, CONSTANTS.STATE_KILLED, CONSTANTS.STATE_FAILED] } } });

const findActiveLobbiesForUser = async user => user.getLobbies({ where: { state: { [Op.notIn]: [CONSTANTS.STATE_COMPLETED, CONSTANTS.STATE_COMPLETED_NO_STATS, CONSTANTS.STATE_KILLED, CONSTANTS.STATE_FAILED] } } });

const findAllInProgressLobbies = async () => db.Lobby.findAll({ where: { state: CONSTANTS.STATE_MATCH_IN_PROGRESS } });

const findAllMatchEndedLobbies = async () => db.Lobby.findAll({ where: { state: CONSTANTS.STATE_MATCH_ENDED } });

const findAllLobbiesInState = async state => db.Lobby.findAll({ where: { state } });

const findAllLobbiesInStateForInhouse = state => async guildId => db.Lobby.findAll({ where: { state }, include: [{ model: db.League, where: { guildId } }] });

const findAllLobbiesForInhouse = async league => db.Lobby.findAll({ where: { leagueId: league.id } });

const findAllEnabledQueues = async guildId => db.Queue.findAll({ where: { enabled: true }, include: [{ model: db.League, where: { guildId } }] });

const findLeague = async guildId => db.League.findOne({ where: { guildId } });

const findLeagueById = async id => db.League.findOne({ where: { id } });

const findOrCreateLeague = guildId => async queues => db.sequelize.transaction(async (t) => {
    const [league] = await db.League.findOrCreate({
        where: { guildId },
        transaction: t,
    });
    const [season] = await db.Season.findOrCreate({
        where: { leagueId: league.id, active: true },
        include: [db.League],
        transaction: t,
    });
    await league.update({ currentSeasonId: season.id }, { transaction: t });
    await Fp.allPromise(queues.map(queue => db.Queue.findOrCreate({
        where: { leagueId: league.id, queueType: queue.queueType },
        defaults: { queueName: queue.queueName },
        include: [db.League],
        transaction: t,
    })));
    return league;
});

const createSeason = guildId => async name => db.sequelize.transaction(async (t) => {
    const league = await findLeague(guildId);
    await db.Season.update({ active: false }, { where: { leagueId: league.id }, transaction: t });
    const season = await db.Season.create({ leagueId: league.id, active: true, name }, { transaction: t });
    await league.update({ currentSeasonId: season.id }, { transaction: t });
    return season;
});

const findOrCreateBot = async (steamId64, accountName, personaName, password) => db.Bot.findOrCreate({
    where: { steamId64 },
    defaults: { accountName, personaName, password },
});

const findOrCreateLobby = async (league, queueType, lobbyName) => db.Lobby.findOrCreate({
    where: { leagueId: league.id, seasonId: league.currentSeasonId, lobbyName },
    defaults: { queueType, state: CONSTANTS.STATE_NEW, password: hri.random() },
    include: [{
        model: db.League,
        where: { id: league.id },
    }],
}).spread(lobby => lobby);

const findOrCreateLobbyForGuild = async (guildId, queueType, lobbyName) => findOrCreateLobby(await findLeague(guildId), queueType, lobbyName);

const findLobbyByName = async lobbyName => db.Lobby.scope({ method: ['lobbyName', lobbyName] }).findOne();

const findLobbyById = async id => db.Lobby.findOne({ where: { id } });

const findLobbyByMatchId = async matchId => db.Lobby.findOne({ where: { matchId } });

const findLobbyByDotaLobbyId = async dotaLobbyId => db.Lobby.findOne({ where: { dotaLobbyId } });

const findLobbyByDiscordChannel = guildId => async channelId => db.Lobby.findOne({ where: { channelId }, include: [{ model: db.League, where: { guildId } }] });

const findBot = async id => db.Bot.findOne({ where: { id } });

const findBotBySteamId64 = async steamId64 => db.Bot.findOne({ where: { steamId64 } });

const findAllBotsForLeague = async league => db.Bot.findAll({
    include: [{
        model: db.Ticket,
        include: [{
            model: db.League,
            where: { id: league.id },
        }],
    }],
});

const findAllUnassignedBotForLeagueTicket = async league => db.Bot.findAll({
    where: {
        status: { [Op.in]: [CONSTANTS.BOT_OFFLINE, CONSTANTS.BOT_IDLE] },
        lobbyCount: { [Op.lt]: 5 },
    },
    include: [{
        model: db.Ticket,
        where: { leagueid: league.leagueid },
    }],
});

const findAllUnassignedBotWithNoTicket = async () => db.Bot.findAll({
    where: {
        '$Tickets.id$': { [Op.eq]: null },
        status: { [Op.in]: [CONSTANTS.BOT_OFFLINE, CONSTANTS.BOT_IDLE] },
        lobbyCount: 0,
    },
    include: [{
        model: db.Ticket,
        required: false, // do not generate INNER JOIN
        attributes: [], // do not return any columns of the Ticket table
    }],
});

const findUnassignedBot = async league => (league.leagueid ? findAllUnassignedBotForLeagueTicket(league) : findAllUnassignedBotWithNoTicket()).then(bots => bots[0]);

const assignBotToLobby = lobby => async botId => db.sequelize.transaction(async (t) => {
    await db.Lobby.update({ botId }, { where: { id: lobby.id }, transaction: t });
    await db.Bot.increment({ lobbyCount: 1 }, { where: { id: botId }, transaction: t });
});

const unassignBotFromLobby = lobby => async botId => db.sequelize.transaction(async (t) => {
    await db.Lobby.update({ botId: null, dotaLobbyId: null }, { where: { id: lobby.id }, transaction: t });
    await db.Bot.increment({ lobbyCount: -1 }, { where: { id: botId }, transaction: t });
});

const findUserById = async id => db.User.scope({ method: ['id', id] }).findOne();

const findUserByDiscordId = guildId => async discordId => db.User.scope({ method: ['guild', guildId] }, { method: ['discordId', discordId] }).findOne();

const findUserBySteamId64 = guildId => async steamId64 => db.User.scope({ method: ['guild', guildId] }, { method: ['steamId64', steamId64] }).findOne();

const findUserByNickname = guildId => async nickname => db.User.scope({ method: ['guild', guildId] }, { method: ['nickname', nickname] }).findOne();

const findUserByNicknameLevenshtein = guildId => async member => db.sequelize.query('SELECT * FROM "Users" as u JOIN "Leagues" as l ON u.leagueId = l.id WHERE l.guildId = :guildId AND levenshtein(LOWER(u.nickname), LOWER(:nickname)) &lt; 2', { replacements: { guildId, nickname: member }, model: db.User });

const findOrCreateUser = async (league, steamId64, discordId, rankTier) => db.User.findOrCreate({
    where: { leagueId: league.id, steamId64, discordId },
    defaults: { rankTier, rating: league.initialRating },
    include: [{
        model: db.League,
        where: { id: league.id },
    }],
}).spread(user => user);

const findOrCreateQueue = async (league, enabled, queueType, queueName) => db.Queue.findOrCreate({
    where: { leagueId: league.id, enabled, queueType },
    defaults: { enabled, queueName },
    include: [{
        model: db.League,
        where: { id: league.id },
    }],
}).spread(queue => queue);

const findQueue = async (leagueId, enabled, queueType) => db.Queue.findOne({
    where: { leagueId, enabled, queueType },
    include: [{
        model: db.League,
        where: { id: leagueId },
    }],
});

const queryUserLeaderboardRank = leagueId => seasonId => async userId => db.sequelize.query('SELECT rank FROM (SELECT *, rank() OVER (ORDER BY rating DESC) FROM "Leaderboards" WHERE "leagueId" = :leagueId AND "seasonId" = :seasonId) AS ranking WHERE "userId" = :userId LIMIT 1',
    { replacements: { leagueId, seasonId, userId }, type: db.sequelize.QueryTypes.SELECT }).then(([rank]) => (rank ? rank.rank : null));

const queryLeaderboardRank = leagueId => seasonId => async limit => db.sequelize.query('SELECT * FROM (SELECT *, rank() OVER (ORDER BY rating DESC) FROM "Leaderboards" WHERE "leagueId" = :leagueId AND "seasonId" = :seasonId LIMIT :limit) AS ranking INNER JOIN "Users" as users ON ranking."userId" = users.id',
    { replacements: { leagueId, seasonId, limit }, type: db.sequelize.QueryTypes.SELECT });

const findOrCreateLeaderboard = lobby => user => async rating => db.Leaderboard.findOrCreate({
    where: { leagueId: lobby.leagueId, seasonId: lobby.seasonId, userId: user.id },
    defaults: { rating, wins: 0, losses: 0 },
}).spread(u => u);

const incrementLeaderboardRecord = wins => losses => async leaderboard => leaderboard.increment({ wins, losses });

const updateLeague = guildId => async values => db.League.update(values, { where: { guildId } });

const updateUserRating = user => async rating => db.User.update({ rating }, { where: { id: user.id } });

const updateLobbyName = lobbyOrState => async lobbyName => db.Lobby.update({ lobbyName }, { where: { id: lobbyOrState.id } });

const updateLobbyChannel = lobbyOrState => async channel => db.Lobby.update({ channelId: channel.id }, { where: { id: lobbyOrState.id } });

const updateLobbyRole = lobbyOrState => async role => db.Lobby.update({ roleId: role.id }, { where: { id: lobbyOrState.id } });

const updateLobbyState = lobbyOrState => async state => db.Lobby.update({ state }, { where: { id: lobbyOrState.id } });

const updateLobbyWinner = lobbyOrState => async winner => db.Lobby.update({ winner }, { where: { id: lobbyOrState.id } });

const updateLobby = async lobbyOrState => db.Lobby.update(lobbyOrState, { where: { id: lobbyOrState.id } });

const updateLobbyFailed = lobbyOrState => async failReason => db.Lobby.update({ state: CONSTANTS.STATE_FAILED, failReason }, { where: { id: lobbyOrState.id } });

const updateBotStatusBySteamId = status => async steamId64 => db.Bot.update({ status }, { where: { steamId64 } });

const updateBotStatus = status => async id => db.Bot.update({ status }, { where: { id } });

const setAllBotsOffline = async () => db.Bot.update({ status: CONSTANTS.BOT_OFFLINE }, { where: { status: { [Op.notLike]: CONSTANTS.BOT_OFFLINE } } });

const updateBot = steamId64 => async values => db.Bot.update(values, { where: { steamId64 } });

const updateQueuesForUser = active => async (user) => {
    const queues = await user.getQueues();
    await Fp.allPromise(queues.map((queue) => {
        // eslint-disable-next-line no-param-reassign
        queue.LobbyQueuer.active = active;
        return queue.LobbyQueuer.save();
    }));
    return user;
};

const destroyQueueByName = league => async queueName => db.Queue.destroy({ where: { queueName, leagueId: league.id } });

const destroyLobbyQueuers = async lobby => db.LobbyQueuer.destroy({ where: { lobbyId: lobby.id } });

const findOrCreateCommend = lobby => giver => async receiver => db.Commend.findOrCreate({ where: { lobbyId: lobby.id, recipientUserId: receiver.id, giverUserId: giver.id } });

const findOrCreateReputation = giver => async receiver => db.Reputation.findOrCreate({ where: { recipientUserId: receiver.id, giverUserId: giver.id } });

const destroyBotBySteamID64 = async steamId64 => db.Bot.destroy({ where: { steamId64 } });

const destroyCommend = lobby => giver => async receiver => db.Commend.destroy({ where: { lobbyId: lobby.id, recipientUserId: receiver.id, giverUserId: giver.id } });

const destroyReputation = giver => async receiver => db.Reputation.destroy({ where: { recipientUserId: receiver.id, giverUserId: giver.id } });

const getChallengeBetweenUsers = giver => receiver => giver.getChallengesGiven({ where: { recipientUserId: receiver.id } }).then(challenges => challenges[0]);

const createChallenge = giver => receiver => db.Challenge.create({ accepted: false, giverUserId: giver.id, recipientUserId: receiver.id });

const destroyChallengeBetweenUsers = giver => async receiver => db.Challenge.destroy({ where: { giverUserId: giver.id, recipientUserId: receiver.id } });

const destroyAllAcceptedChallengeForUser = async (user) => {
    await db.Challenge.destroy({ where: { giverUserId: user.id, accepted: true } });
    await db.Challenge.destroy({ where: { recipientUserId: user.id, accepted: true } });
};

const setChallengeAccepted = async challenge => challenge.update({ accepted: true });

const unvouchUser = async user => user.update({ vouched: false });

const findLobbyQueuersByUserId = async userId => db.LobbyQueuer.findAll({ where: { userId } });

const findTicketById = async id => db.Ticket.findOne({ where: { id } });

const findTicketByDotaLeagueId = async leagueid => db.Ticket.findOne({ where: { leagueid } });

const upsertTicket = async ({
    leagueid,
    name,
    mostRecentActivity,
    startTimestamp,
    endTimestamp,
}) => db.Ticket.upsert({
    leagueid,
    name,
    mostRecentActivity,
    startTimestamp,
    endTimestamp,
}, { returning: true }).spread(ticket => ticket);

const addTicketOf = leagueOrBot => async ticket => leagueOrBot.addTicket(ticket);

const getTicketsOf = options => async leagueOrBot => leagueOrBot.getTickets(options);

const setTicketsOf = leagueOrBot => async tickets => leagueOrBot.setTickets(tickets);

const removeTicketOf = leagueOrBot => async ticket => leagueOrBot.removeTicket(ticket);

const removeTicketsOf = async leagueOrBot => leagueOrBot.setTickets([]);

module.exports = {
    findAllLeagues,
    findAllActiveLobbiesForInhouse,
    findAllActiveLobbies,
    findActiveLobbiesForUser,
    findAllInProgressLobbies,
    findAllMatchEndedLobbies,
    findAllLobbiesInState,
    findAllLobbiesInStateForInhouse,
    findAllLobbiesForInhouse,
    findAllEnabledQueues,
    findLeague,
    findLeagueById,
    findOrCreateLeague,
    createSeason,
    findOrCreateBot,
    findOrCreateLobby,
    findOrCreateLobbyForGuild,
    findLobbyByName,
    findLobbyById,
    findLobbyByMatchId,
    findLobbyByDotaLobbyId,
    findLobbyByDiscordChannel,
    findBot,
    findBotBySteamId64,
    findAllBotsForLeague,
    findAllUnassignedBotForLeagueTicket,
    findAllUnassignedBotWithNoTicket,
    findUnassignedBot,
    assignBotToLobby,
    unassignBotFromLobby,
    findOrCreateUser,
    findOrCreateQueue,
    findQueue,
    findUserById,
    findUserByDiscordId,
    findUserBySteamId64,
    findUserByNickname,
    findUserByNicknameLevenshtein,
    queryUserLeaderboardRank,
    queryLeaderboardRank,
    findOrCreateLeaderboard,
    incrementLeaderboardRecord,
    updateLeague,
    updateUserRating,
    updateLobbyName,
    updateLobbyChannel,
    updateLobbyRole,
    updateLobbyState,
    updateLobbyWinner,
    updateLobby,
    updateLobbyFailed,
    updateBotStatusBySteamId,
    updateBotStatus,
    setAllBotsOffline,
    updateBot,
    updateQueuesForUser,
    destroyQueueByName,
    destroyLobbyQueuers,
    findOrCreateCommend,
    findOrCreateReputation,
    destroyBotBySteamID64,
    destroyCommend,
    destroyReputation,
    getChallengeBetweenUsers,
    createChallenge,
    setChallengeAccepted,
    destroyChallengeBetweenUsers,
    destroyAllAcceptedChallengeForUser,
    unvouchUser,
    findLobbyQueuersByUserId,
    findTicketById,
    findTicketByDotaLeagueId,
    upsertTicket,
    addTicketOf,
    getTicketsOf,
    setTicketsOf,
    removeTicketOf,
    removeTicketsOf,
};
</code></pre>
        </article>
    </section>




                </div>
            </div>
        </div>
    </div>

<footer class="footer">
    <div class="content has-text-centered">
        <p><a href="https://github.com/devilesk/dota-ihl-bot/tree/master/docs">Documentation source on Github</a></p>
        <p>Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Thu Apr 25 2019 12:50:41 GMT+0000 (Coordinated Universal Time)</p>
        <p class="sidebar-created-by">
            <a href="https://github.com/SoftwareBrothers/better-docs" target="_blank">BetterDocs theme</a> provided with <i class="fas fa-heart"></i> by 
            <a href="http://softwarebrothers.co" target="_blank">SoftwareBrothers</a>
        </p>
    </div>
</footer>

<script> prettyPrint(); </script>
<script src="scripts/app.min.js"></script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
