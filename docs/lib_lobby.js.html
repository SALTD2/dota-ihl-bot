

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Source: lib/lobby.js | dota-ihl-bot</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-jsdoc.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/tui-doc.css">

    
</head>
<body>
<nav class="lnb" id="lnb">
    <div class="logo" style="">
        
            <img src="img/toast-ui.png" width="100%" height="100%">
        
    </div>
    <div class="title">
        <h1><a href="index.html" class="link">dota-ihl-bot</a></h1>
        
            <span class="version">v0.1.0</span>
        
    </div>
    <div class="search-container" id="search-container">
        <input type="text" placeholder="Search">
        <ul></ul>
    </div>
    
    <div class="lnb-api hidden"><h3>Modules</h3><ul><li><a href="module-constants.html">constants</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:constants_sub"></div></li><li><a href="module-db.html">db</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:db_sub"></div></li><li><a href="module-dotaBot.html">dotaBot</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:dotaBot_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-dotaBot.html#~isDotaLobbyReady">isDotaLobbyReady</a></li><li><a href="module-dotaBot.html#~slotToTeam">slotToTeam</a></li><li><a href="module-dotaBot.html#~startDotaLobby">startDotaLobby</a></li><li><a href="module-dotaBot.html#~updatePlayerState">updatePlayerState</a></li></ul><div class="member-type">Typedef</div><ul class="inner"><li><a href="module-dotaBot.html#.LogOnDetails">LogOnDetails</a></li></ul></div></li><li><a href="module-guild.html">guild</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:guild_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-guild.html#~resolveRole">resolveRole</a></li><li><a href="module-guild.html#~resolveUser">resolveUser</a></li></ul></div></li><li><a href="module-ihl.html">ihl</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:ihl_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-ihl.html#~banInhouseQueue">banInhouseQueue</a></li><li><a href="module-ihl.html#~createInhouseState">createInhouseState</a></li><li><a href="module-ihl.html#~getAllLobbyQueues">getAllLobbyQueues</a></li><li><a href="module-ihl.html#~getAllLobbyQueuesForUser">getAllLobbyQueuesForUser</a></li><li><a href="module-ihl.html#~getUserRankTier">getUserRankTier</a></li><li><a href="module-ihl.html#~hasActiveLobbies">hasActiveLobbies</a></li><li><a href="module-ihl.html#~joinLobbyQueue">joinLobbyQueue</a></li><li><a href="module-ihl.html#~leaveLobbyQueue">leaveLobbyQueue</a></li><li><a href="module-ihl.html#~registerUser">registerUser</a></li></ul><div class="member-type">Typedef</div><ul class="inner"><li><a href="module-ihl.html#.InhouseState">InhouseState</a></li><li><a href="module-ihl.html#.LeagueGuildObject">LeagueGuildObject</a></li></ul></div></li><li><a href="module-ihlManager.html">ihlManager</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:ihlManager_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-ihlManager.html#~findUser">findUser</a></li><li><a href="module-ihlManager.html#~loadInhouseStates">loadInhouseStates</a></li><li><a href="module-ihlManager.html#~loadInhouseStatesFromLeagues">loadInhouseStatesFromLeagues</a></li></ul><div class="member-type">Events</div><ul class="inner"><li><a href="module-ihlManager.html#~event:empty">empty</a></li><li><a href="module-ihlManager.html#~event:EVENT_GUILD_MESSAGE">EVENT_GUILD_MESSAGE</a></li><li><a href="module-ihlManager.html#~event:EVENT_GUILD_USER_LEFT">EVENT_GUILD_USER_LEFT</a></li><li><a href="module-ihlManager.html#~event:EVENT_LOBBY_FORCE_DRAFT">EVENT_LOBBY_FORCE_DRAFT</a></li><li><a href="module-ihlManager.html#~event:EVENT_PICK_PLAYER">EVENT_PICK_PLAYER</a></li><li><a href="module-ihlManager.html#~event:EVENT_PLAYER_READY">EVENT_PLAYER_READY</a></li><li><a href="module-ihlManager.html#~event:EVENT_RUN_LOBBY">EVENT_RUN_LOBBY</a></li><li><a href="module-ihlManager.html#~event:ready">ready</a></li></ul><div class="member-type">Typedef</div><ul class="inner"><li><a href="module-ihlManager.html#~eventCallback">eventCallback</a></li></ul></div></li><li><a href="module-lobby.html">lobby</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:lobby_sub"><div class="member-type">Typedef</div><ul class="inner"><li><a href="module-lobby.html#.LobbyState">LobbyState</a></li></ul></div></li><li><a href="module-matchTracker.html">matchTracker</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:matchTracker_sub"></div></li></ul></div><div class="lnb-api hidden"><h3>Externals</h3><ul><li><a href="external-commando.html">commando</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="external:commando_sub"></div></li><li><a href="external-discordjs.html">discordjs</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="external:discordjs_sub"></div></li><li><a href="external-Dota2.html">Dota2</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="external:Dota2_sub"></div></li><li><a href="external-EventEmitter.html">EventEmitter</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="external:EventEmitter_sub"></div></li><li><a href="external-Long.html">Long</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="external:Long_sub"></div></li><li><a href="external-sequelize.html">sequelize</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="external:sequelize_sub"></div></li><li><a href="external-steam.html">steam</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="external:steam_sub"></div></li></ul></div><div class="lnb-api hidden"><h3>Classes</h3><ul><li><a href="BotAddCommand.html">BotAddCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="BotAddCommand_sub"></div></li><li><a href="BotListCommand.html">BotListCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="BotListCommand_sub"></div></li><li><a href="BotRemoveCommand.html">BotRemoveCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="BotRemoveCommand_sub"></div></li><li><a href="BotStatusCommand.html">BotStatusCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="BotStatusCommand_sub"></div></li><li><a href="ChallengeCommand.html">ChallengeCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="ChallengeCommand_sub"></div></li><li><a href="ChallengeListCommand.html">ChallengeListCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="ChallengeListCommand_sub"></div></li><li><a href="CommendCommand.html">CommendCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="CommendCommand_sub"></div></li><li><a href="DireCommand.html">DireCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="DireCommand_sub"></div></li><li><a href="external-discordjs.CategoryChannel.html">CategoryChannel</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="external:discordjs.CategoryChannel_sub"></div></li><li><a href="external-discordjs.Client.html">Client</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="external:discordjs.Client_sub"></div></li><li><a href="external-discordjs.Guild.html">Guild</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="external:discordjs.Guild_sub"></div></li><li><a href="external-discordjs.GuildChannel.html">GuildChannel</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="external:discordjs.GuildChannel_sub"></div></li><li><a href="external-discordjs.GuildMember.html">GuildMember</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="external:discordjs.GuildMember_sub"></div></li><li><a href="external-discordjs.Message.html">Message</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="external:discordjs.Message_sub"></div></li><li><a href="external-discordjs.Role.html">Role</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="external:discordjs.Role_sub"></div></li><li><a href="external-discordjs.User.html">User</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="external:discordjs.User_sub"></div></li><li><a href="external-sequelize.Model.html">Model</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="external:sequelize.Model_sub"></div></li><li><a href="FirstCommand.html">FirstCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="FirstCommand_sub"></div></li><li><a href="GameModeCommand.html">GameModeCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="GameModeCommand_sub"></div></li><li><a href="IHLCommand.html">IHLCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="IHLCommand_sub"></div></li><li><a href="InviteCommand.html">InviteCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="InviteCommand_sub"></div></li><li><a href="InviteUrlCommand.html">InviteUrlCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="InviteUrlCommand_sub"></div></li><li><a href="LeaderboardCommand.html">LeaderboardCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="LeaderboardCommand_sub"></div></li><li><a href="LeagueCreateCommand.html">LeagueCreateCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="LeagueCreateCommand_sub"></div></li><li><a href="LeagueInfoCommand.html">LeagueInfoCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="LeagueInfoCommand_sub"></div></li><li><a href="LeagueSeasonCommand.html">LeagueSeasonCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="LeagueSeasonCommand_sub"></div></li><li><a href="LeagueTicketCommand.html">LeagueTicketCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="LeagueTicketCommand_sub"></div></li><li><a href="LeagueUpdateCommand.html">LeagueUpdateCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="LeagueUpdateCommand_sub"></div></li><li><a href="LobbyDraftCommand.html">LobbyDraftCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="LobbyDraftCommand_sub"></div></li><li><a href="LobbyFirstPickCommand.html">LobbyFirstPickCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="LobbyFirstPickCommand_sub"></div></li><li><a href="LobbyGameModeCommand.html">LobbyGameModeCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="LobbyGameModeCommand_sub"></div></li><li><a href="LobbyInviteCommand.html">LobbyInviteCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="LobbyInviteCommand_sub"></div></li><li><a href="LobbyKickCommand.html">LobbyKickCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="LobbyKickCommand_sub"></div></li><li><a href="LobbyKillCommand.html">LobbyKillCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="LobbyKillCommand_sub"></div></li><li><a href="LobbyRunCommand.html">LobbyRunCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="LobbyRunCommand_sub"></div></li><li><a href="LobbyStartCommand.html">LobbyStartCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="LobbyStartCommand_sub"></div></li><li><a href="LobbyStateCommand.html">LobbyStateCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="LobbyStateCommand_sub"></div></li><li><a href="LobbySwapCommand.html">LobbySwapCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="LobbySwapCommand_sub"></div></li><li><a href="LogLevelCommand.html">LogLevelCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="LogLevelCommand_sub"></div></li><li><a href="module-db.Bot.html">Bot</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:db.Bot_sub"></div></li><li><a href="module-db.BotTicket.html">BotTicket</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:db.BotTicket_sub"></div></li><li><a href="module-db.Challenge.html">Challenge</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:db.Challenge_sub"></div></li><li><a href="module-db.Commend.html">Commend</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:db.Commend_sub"></div></li><li><a href="module-db.Database.html">Database</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:db.Database_sub"></div></li><li><a href="module-db.Leaderboard.html">Leaderboard</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:db.Leaderboard_sub"></div></li><li><a href="module-db.League.html">League</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:db.League_sub"></div></li><li><a href="module-db.LeagueTicket.html">LeagueTicket</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:db.LeagueTicket_sub"></div></li><li><a href="module-db.Lobby.html">Lobby</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:db.Lobby_sub"></div></li><li><a href="module-db.LobbyPlayer.html">LobbyPlayer</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:db.LobbyPlayer_sub"></div></li><li><a href="module-db.LobbyQueuer.html">LobbyQueuer</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:db.LobbyQueuer_sub"></div></li><li><a href="module-db.Queue.html">Queue</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:db.Queue_sub"></div></li><li><a href="module-db.Reputation.html">Reputation</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:db.Reputation_sub"></div></li><li><a href="module-db.Season.html">Season</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:db.Season_sub"></div></li><li><a href="module-db.Ticket.html">Ticket</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:db.Ticket_sub"></div></li><li><a href="module-db.User.html">User</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:db.User_sub"></div></li><li><a href="module-dotaBot-DotaBot.html">DotaBot</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:dotaBot~DotaBot_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="module-dotaBot-DotaBot.html#accountId">accountId</a></li><li><a href="module-dotaBot-DotaBot.html#backoff">backoff</a></li><li><a href="module-dotaBot-DotaBot.html#backoff">backoff</a></li><li><a href="module-dotaBot-DotaBot.html#dotaLobbyId">dotaLobbyId</a></li><li><a href="module-dotaBot-DotaBot.html#lobby">lobby</a></li><li><a href="module-dotaBot-DotaBot.html#lobbyChannelName">lobbyChannelName</a></li><li><a href="module-dotaBot-DotaBot.html#playerState">playerState</a></li><li><a href="module-dotaBot-DotaBot.html#rateLimit">rateLimit</a></li><li><a href="module-dotaBot-DotaBot.html#rateLimit">rateLimit</a></li><li><a href="module-dotaBot-DotaBot.html#state">state</a></li><li><a href="module-dotaBot-DotaBot.html#steamId64">steamId64</a></li><li><a href="module-dotaBot-DotaBot.html#teamCache">teamCache</a></li><li><a href="module-dotaBot-DotaBot.html#teamCache">teamCache</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="module-dotaBot-DotaBot.html#connect">connect</a></li><li><a href="module-dotaBot-DotaBot.html#disconnect">disconnect</a></li><li><a href="module-dotaBot-DotaBot.html#inviteToLobby">inviteToLobby</a></li><li><a href="module-dotaBot-DotaBot.html#joinPracticeLobby">joinPracticeLobby</a></li><li><a href="module-dotaBot-DotaBot.html#practiceLobbyKick">practiceLobbyKick</a></li><li><a href="module-dotaBot-DotaBot.html#practiceLobbyKickFromTeam">practiceLobbyKickFromTeam</a></li><li><a href="module-dotaBot-DotaBot.html#schedule">schedule</a></li></ul></div></li><li><a href="module-ihlManager-IHLManager.html">IHLManager</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:ihlManager~IHLManager_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-ihlManager-IHLManager.html#attachListeners">attachListeners</a></li><li><a href="module-ihlManager-IHLManager.html#banInhouseQueue">banInhouseQueue</a></li><li><a href="module-ihlManager-IHLManager.html#botLeaveLobby">botLeaveLobby</a></li><li><a href="module-ihlManager-IHLManager.html#clearAllLobbyQueues">clearAllLobbyQueues</a></li><li><a href="module-ihlManager-IHLManager.html#clearLobbyQueue">clearLobbyQueue</a></li><li><a href="module-ihlManager-IHLManager.html#createChallengeLobby">createChallengeLobby</a></li><li><a href="module-ihlManager-IHLManager.html#createNewLeague">createNewLeague</a></li><li><a href="module-ihlManager-IHLManager.html#getBot">getBot</a></li><li><a href="module-ihlManager-IHLManager.html#init">init</a></li><li><a href="module-ihlManager-IHLManager.html#joinAllLobbyQueues">joinAllLobbyQueues</a></li><li><a href="module-ihlManager-IHLManager.html#joinLobbyQueue">joinLobbyQueue</a></li><li><a href="module-ihlManager-IHLManager.html#leaveAllLobbyQueues">leaveAllLobbyQueues</a></li><li><a href="module-ihlManager-IHLManager.html#leaveLobbyQueue">leaveLobbyQueue</a></li><li><a href="module-ihlManager-IHLManager.html#loadBot">loadBot</a></li><li><a href="module-ihlManager-IHLManager.html#onBotAvailable">onBotAvailable</a></li><li><a href="module-ihlManager-IHLManager.html#onClientReady">onClientReady</a></li><li><a href="module-ihlManager-IHLManager.html#onCreateLobbyQueue">onCreateLobbyQueue</a></li><li><a href="module-ihlManager-IHLManager.html#onDiscordMemberLeave">onDiscordMemberLeave</a></li><li><a href="module-ihlManager-IHLManager.html#onDiscordMessage">onDiscordMessage</a></li><li><a href="module-ihlManager-IHLManager.html#onDraftMember">onDraftMember</a></li><li><a href="module-ihlManager-IHLManager.html#onforceLobbyDraft">onforceLobbyDraft</a></li><li><a href="module-ihlManager-IHLManager.html#onLeagueTicketAdd">onLeagueTicketAdd</a></li><li><a href="module-ihlManager-IHLManager.html#onLeagueTicketRemove">onLeagueTicketRemove</a></li><li><a href="module-ihlManager-IHLManager.html#onLeagueTicketSet">onLeagueTicketSet</a></li><li><a href="module-ihlManager-IHLManager.html#onLobbyInvite">onLobbyInvite</a></li><li><a href="module-ihlManager-IHLManager.html#onLobbyKick">onLobbyKick</a></li><li><a href="module-ihlManager-IHLManager.html#onLobbyKill">onLobbyKill</a></li><li><a href="module-ihlManager-IHLManager.html#onLobbyReady">onLobbyReady</a></li><li><a href="module-ihlManager-IHLManager.html#onLobbyTimedOut">onLobbyTimedOut</a></li><li><a href="module-ihlManager-IHLManager.html#onMatchNoStats">onMatchNoStats</a></li><li><a href="module-ihlManager-IHLManager.html#onMatchOutcome">onMatchOutcome</a></li><li><a href="module-ihlManager-IHLManager.html#onMatchSignedOut">onMatchSignedOut</a></li><li><a href="module-ihlManager-IHLManager.html#onMatchStats">onMatchStats</a></li><li><a href="module-ihlManager-IHLManager.html#onPlayerReady">onPlayerReady</a></li><li><a href="module-ihlManager-IHLManager.html#onSelectionPick">onSelectionPick</a></li><li><a href="module-ihlManager-IHLManager.html#onSelectionSide">onSelectionSide</a></li><li><a href="module-ihlManager-IHLManager.html#onSetBotStatus">onSetBotStatus</a></li><li><a href="module-ihlManager-IHLManager.html#onSetLobbyState">onSetLobbyState</a></li><li><a href="module-ihlManager-IHLManager.html#onStartDotaLobby">onStartDotaLobby</a></li><li><a href="module-ihlManager-IHLManager.html#processEventQueue">processEventQueue</a></li><li><a href="module-ihlManager-IHLManager.html#queueEvent">queueEvent</a></li><li><a href="module-ihlManager-IHLManager.html#registerLobbyTimeout">registerLobbyTimeout</a></li><li><a href="module-ihlManager-IHLManager.html#removeBot">removeBot</a></li><li><a href="module-ihlManager-IHLManager.html#runLobbiesForInhouse">runLobbiesForInhouse</a></li><li><a href="module-ihlManager-IHLManager.html#runLobby">runLobby</a></li><li><a href="module-ihlManager-IHLManager.html#unregisterLobbyTimeout">unregisterLobbyTimeout</a></li></ul></div></li><li><a href="module-matchTracker-MatchTracker.html">MatchTracker</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:matchTracker~MatchTracker_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-matchTracker-MatchTracker.html#disable">disable</a></li><li><a href="module-matchTracker-MatchTracker.html#enable">enable</a></li><li><a href="module-matchTracker-MatchTracker.html#run">run</a></li></ul></div></li><li><a href="NicknameCommand.html">NicknameCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="NicknameCommand_sub"></div></li><li><a href="PickCommand.html">PickCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="PickCommand_sub"></div></li><li><a href="Queue.html">Queue</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Queue_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="Queue.html#.State">State</a></li><li><a href="Queue.html#backoff">backoff</a></li><li><a href="Queue.html#backoff">backoff</a></li><li><a href="Queue.html#rateLimit">rateLimit</a></li><li><a href="Queue.html#rateLimit">rateLimit</a></li><li><a href="Queue.html#state">state</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="Queue.html#block">block</a></li><li><a href="Queue.html#clear">clear</a></li><li><a href="Queue.html#release">release</a></li><li><a href="Queue.html#schedule">schedule</a></li></ul></div></li><li><a href="QueueBanCommand.html">QueueBanCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="QueueBanCommand_sub"></div></li><li><a href="QueueClearCommand.html">QueueClearCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="QueueClearCommand_sub"></div></li><li><a href="QueueJoinCommand.html">QueueJoinCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="QueueJoinCommand_sub"></div></li><li><a href="QueueLeaveCommand.html">QueueLeaveCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="QueueLeaveCommand_sub"></div></li><li><a href="QueueReadyCommand.html">QueueReadyCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="QueueReadyCommand_sub"></div></li><li><a href="QueueStatusCommand.html">QueueStatusCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="QueueStatusCommand_sub"></div></li><li><a href="RadiantCommand.html">RadiantCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="RadiantCommand_sub"></div></li><li><a href="RegisterCommand.html">RegisterCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="RegisterCommand_sub"></div></li><li><a href="RepCommand.html">RepCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="RepCommand_sub"></div></li><li><a href="RestartCommand.html">RestartCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="RestartCommand_sub"></div></li><li><a href="RolesCommand.html">RolesCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="RolesCommand_sub"></div></li><li><a href="SecondCommand.html">SecondCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="SecondCommand_sub"></div></li><li><a href="TicketAddCommand.html">TicketAddCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="TicketAddCommand_sub"></div></li><li><a href="TicketRemoveCommand.html">TicketRemoveCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="TicketRemoveCommand_sub"></div></li><li><a href="UnchallengeCommand.html">UnchallengeCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="UnchallengeCommand_sub"></div></li><li><a href="UncommendCommand.html">UncommendCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="UncommendCommand_sub"></div></li><li><a href="UnrepCommand.html">UnrepCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="UnrepCommand_sub"></div></li><li><a href="UserBadgeCommand.html">UserBadgeCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="UserBadgeCommand_sub"></div></li><li><a href="UserVouchCommand.html">UserVouchCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="UserVouchCommand_sub"></div></li><li><a href="WhoisCommand.html">WhoisCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="WhoisCommand_sub"></div></li></ul></div><div class="lnb-api hidden"><h3>Global</h3><ul><li><a href="global.html#cache">cache</a></li><li><a href="global.html#shuffle">shuffle</a></li></ul></div>
</nav>
<div id="resizer"></div>

<div class="main" id="main">
    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @module lobby
 */

/**
 * @typedef module:lobby.LobbyState
 * @type {Object}
 * @property {module:ihl.InhouseState} inhouseState - The inhouse state the lobby belongs to.
 * @property {external:discordjs.GuildChannel} channel - The discord lobby channel.
 * @property {external:discordjs.Role} role - The discord lobby role.
 * @property {number} readyCheckTime - Start of lobby ready timer.
 * @property {string} state - The lobby state.
 * @property {number} botId - The record id of the bot hosting the lobby.
 * @property {string} queueType - The lobby queue type.
 * @property {string} lobbyName - The lobby name.
 * @property {string} dotaLobbyId - The dota lobby id.
 * @property {string} password - The lobby password.
 * @property {string} captain1UserId - The first captain user record id.
 * @property {string} captain2UserId - The second captain user record id.
 * @property {string} matchId - The match id for the lobby.
 */

const util = require('util');
const Promise = require('bluebird');
const Sequelize = require('sequelize');

const logger = require('./logger');
const shuffle = require('./util/shuffle');
const combinations = require('./util/combinations');
const templateString = require('./util/templateString');
const capitalize = require('./util/capitalize');
const CONSTANTS = require('./constants');
const Guild = require('./guild');
const Db = require('./db');
const Fp = require('./util/fp');
const AsyncLock = require('async-lock');

const lock = new AsyncLock();

const getLobby = async lobbyOrState => (lobbyOrState instanceof Sequelize.Model ? lobbyOrState.reload() : Db.findLobbyById(lobbyOrState.id));

const getPlayers = options => async lobbyOrState => getLobby(lobbyOrState).then(lobby => (lobby ? lobby.getPlayers(options) : []));

const getPlayerByUserId = lobbyOrState => async id => getPlayers({ where: { id } })(lobbyOrState).then(players => (players ? players[0] : null));

const getPlayerBySteamId = lobbyOrState => async steamId64 => getPlayers({ where: { steamId64 } })(lobbyOrState).then(players => (players ? players[0] : null));

const getPlayerByDiscordId = lobbyOrState => async discordId => getPlayers({ where: { discordId } })(lobbyOrState).then(players => (players ? players[0] : null));

const getNoFactionPlayers = options => async lobbyOrState => getLobby(lobbyOrState).then(lobby => (lobby ? lobby.getNoFactionPlayers(options) : []));

const getFaction1Players = options => async lobbyOrState => getLobby(lobbyOrState).then(lobby => (lobby ? lobby.getFaction1Players(options) : []));

const getFaction2Players = options => async lobbyOrState => getLobby(lobbyOrState).then(lobby => (lobby ? lobby.getFaction2Players(options) : []));

const getRadiantPlayers = options => async lobbyOrState => getLobby(lobbyOrState).then((lobby) => {
    if (lobby) {
        if (lobby.radiantFaction === 1) {
            return lobby.getFaction1Players(options);
        }
        return lobby.getFaction2Players(options);
    }
    return [];
});

const getDirePlayers = options => async lobbyOrState => getLobby(lobbyOrState).then((lobby) => {
    if (lobby) {
        if (lobby.radiantFaction === 2) {
            return lobby.getFaction1Players(options);
        }
        return lobby.getFaction2Players(options);
    }
    return [];
});

const getNotReadyPlayers = options => async lobbyOrState => getLobby(lobbyOrState).then(lobby => (lobby ? lobby.getNotReadyPlayers(options) : []));

const getReadyPlayers = options => async lobbyOrState => getLobby(lobbyOrState).then(lobby => (lobby ? lobby.getReadyPlayers(options) : []));

const mapPlayers = fn => async lobbyOrState => Fp.pipeP(getPlayers(), Fp.mapPromise(fn))(lobbyOrState);

const addPlayer = lobbyOrState => async user => getLobby(lobbyOrState).then(lobby => (lobby ? lobby.addPlayer(user) : null));

const removePlayer = lobbyOrState => async user => getLobby(lobbyOrState).then(lobby => (lobby ? lobby.removePlayer(user) : null));

const addPlayers = lobbyOrState => async users => Fp.mapPromise(addPlayer(lobbyOrState))(users);

const addRoleToPlayers = async lobbyState => mapPlayers(Guild.addRoleToUser(lobbyState.inhouseState.guild)(lobbyState.role))(lobbyState);

const updateLobbyPlayer = data => lobbyOrState => async id => getPlayerByUserId(lobbyOrState)(id).then(player => (player ? player.LobbyPlayer.update(data) : null));

const updateLobbyPlayerBySteamId = data => lobbyOrState => async steamId64 => getPlayerBySteamId(lobbyOrState)(steamId64).then(player => (player ? player.LobbyPlayer.update(data) : null));

const setPlayerReady = ready => updateLobbyPlayer({ ready });

const setPlayerFaction = faction => updateLobbyPlayer({ faction });

const sortQueuersAsc = async queuers => Promise.resolve(queuers).then(q => (q ? q.sort((a, b) => a.LobbyQueuer.createdAt - b.LobbyQueuer.createdAt) : []));

const getQueuers = options => async lobbyOrState => getLobby(lobbyOrState).then(lobby => (lobby ? lobby.getQueuers(options) : []));

const getActiveQueuers = options => async lobbyOrState => getLobby(lobbyOrState).then(lobby => (lobby ? lobby.getActiveQueuers(options) : [])).then(sortQueuersAsc);

const getQueuerByUserId = lobbyOrState => async id => getQueuers({ where: { id } })(lobbyOrState).then(queuers => (queuers ? queuers[0] : null));

const getQueuerBySteamId = lobbyOrState => async steamId64 => getQueuers({ where: { steamId64 } })(lobbyOrState).then(queuers => (queuers ? queuers[0] : null));

const getQueuerByDiscordId = lobbyOrState => async discordId => getQueuers({ where: { discordId } })(lobbyOrState).then(queuers => (queuers ? queuers[0] : null));

const mapQueuers = fn => async lobbyOrState => Fp.pipeP(getQueuers(), Fp.mapPromise(fn))(lobbyOrState);

const mapActiveQueuers = fn => async lobbyOrState => Fp.pipeP(getActiveQueuers(), Fp.mapPromise(fn))(lobbyOrState);

const hasQueuer = lobbyOrState => async user => getLobby(lobbyOrState).then(lobby => (lobby ? lobby.hasQueuer(user) : false));

const addQueuer = lobbyOrState => async user => getLobby(lobbyOrState).then(lobby => (lobby ? lobby.addQueuer(user) : null));

const removeQueuer = lobbyOrState => async user => getLobby(lobbyOrState).then(lobby => (lobby ? lobby.removeQueuer(user) : null));

const addQueuers = lobbyOrState => async users => Fp.mapPromise(addQueuer(lobbyOrState))(users);

const addRoleToQueuers = async lobbyState => mapQueuers(Guild.addRoleToUser(lobbyState.inhouseState.guild)(lobbyState.role))(lobbyState);

const updateLobbyQueuer = data => lobbyOrState => async id => getQueuerByUserId(lobbyOrState)(id).then(queuer => (queuer ? queuer.LobbyQueuer.update(data) : null));

const updateLobbyQueuerBySteamId = data => lobbyOrState => async steamId64 => getQueuerBySteamId(lobbyOrState)(steamId64).then(queuer => (queuer ? queuer.LobbyQueuer.update(data) : null));

const setQueuerActive = active => updateLobbyQueuer({ active });

const removeUserFromQueues = async user => user.setQueues([]);

const removeQueuers = async lobbyOrState => getLobby(lobbyOrState).then(lobby => (lobby ? lobby.setQueuers([]) : null));

const removePlayers = async lobbyOrState => getLobby(lobbyOrState).then(lobby => (lobby ? lobby.setPlayers([]) : null));

const lobbyQueuerToPlayer = lobbyOrState => async user => Fp.pipeP(Db.updateQueuesForUser(false), addPlayer(lobbyOrState))(user);

const returnPlayerToQueue = lobbyOrState => async user => Fp.pipeP(Db.updateQueuesForUser(true), removePlayer(lobbyOrState))(user);

const returnPlayersToQueue = async lobbyOrState => mapPlayers(returnPlayerToQueue(lobbyOrState))(lobbyOrState);

const isUserInGuild = guild => async (user) => {
    try {
        await Guild.resolveUser(guild)(user);
        return true;
    }
    catch (e) {
        return false;
    }
};

const cleanMissingPlayers = async lobbyState => Fp.pipeP(
    getPlayers(),
    Fp.filterPromise(Fp.negateP(isUserInGuild(lobbyState.inhouseState.guild))),
    Fp.mapPromise(Db.unvouchUser),
    Fp.mapPromise(removePlayer(lobbyState)),
)(lobbyState);

const cleanMissingQueuers = async lobbyState => Fp.pipeP(
    getQueuers(),
    Fp.filterPromise(Fp.negateP(isUserInGuild(lobbyState.inhouseState.guild))),
    Fp.mapPromise(Db.unvouchUser),
    Fp.mapPromise(removeQueuer(lobbyState)),
)(lobbyState);

const checkPlayers = async (lobbyState) => {
    try {
        const players = await getPlayers()(lobbyState);
        if (players.length !== 10) {
            return { ...lobbyState, state: CONSTANTS.STATE_FAILED, failReason: 'checkPlayers: invalid player count {e.toString()}' };
        }
        try {
            await Fp.mapPromise(Guild.resolveUser(lobbyState.inhouseState.guild))(players);
        }
        catch (e) {
            return { ...lobbyState, state: CONSTANTS.STATE_FAILED, failReason: 'checkPlayers: missing player {e.toString()}' };
        }
    }
    catch (e) {
        return { ...lobbyState, state: CONSTANTS.STATE_FAILED, failReason: 'checkPlayers: {e.toString()}' };
    }
    return { ...lobbyState };
};

const validateLobbyPlayers = async (_lobbyState) => {
    let lobbyState;
    switch (_lobbyState.state) {
    case CONSTANTS.STATE_WAITING_FOR_PLAYERS:
    case CONSTANTS.STATE_BOT_STARTED:
    case CONSTANTS.STATE_BOT_FAILED:
    case CONSTANTS.STATE_BOT_ASSIGNED:
    case CONSTANTS.STATE_WAITING_FOR_BOT:
    case CONSTANTS.STATE_TEAMS_SELECTED:
    case CONSTANTS.STATE_AUTOBALANCING:
    case CONSTANTS.STATE_DRAFTING_PLAYERS:
    case CONSTANTS.STATE_SELECTION_PRIORITY:
    case CONSTANTS.STATE_ASSIGNING_CAPTAINS:
        // remove lobby players and add them back as active queuers
        lobbyState = await checkPlayers(_lobbyState);
        if (lobbyState.state === CONSTANTS.STATE_FAILED) {
            logger.silly(`validateLobbyPlayers ${lobbyState.id} failed, returning players to queue`);
            await Fp.pipeP(
                getPlayers(),
                addQueuers(lobbyState),
            )(lobbyState);
            await returnPlayersToQueue(lobbyState);
            lobbyState.state = CONSTANTS.STATE_WAITING_FOR_QUEUE;
            await Db.updateLobby(lobbyState);
        }
        break;
    case CONSTANTS.STATE_CHECKING_READY:
    case CONSTANTS.STATE_BEGIN_READY:
        // remove lobby players and set queuers active
        lobbyState = await checkPlayers(_lobbyState);
        if (lobbyState.state === CONSTANTS.STATE_FAILED) {
            logger.silly(`validateLobbyPlayers ${lobbyState.id} failed, returning players to queue`);
            await returnPlayersToQueue(lobbyState);
            lobbyState.state = CONSTANTS.STATE_WAITING_FOR_QUEUE;
            await Db.updateLobby(lobbyState);
        }
        break;
    case CONSTANTS.STATE_WAITING_FOR_QUEUE:
    case CONSTANTS.STATE_NEW:
    default:
        logger.silly(`validateLobbyPlayers ${_lobbyState.id} default ${_lobbyState.state}`);
        return { ..._lobbyState };
    }
    logger.silly(`validateLobbyPlayers ${lobbyState.id} end ${_lobbyState.state} to ${lobbyState.state}`);
    return lobbyState;
};

const calcBalanceTeams = getPlayerRating => (players) => {
    logger.silly('calcBalanceTeams');
    const combs = combinations(players, 5);
    let bestWeightDiff = 999999;
    let bestPairs = [];
    combs.forEach((comb) => {
        const team1 = comb;
        const team2 = players.filter(i => comb.indexOf(i) &lt; 0);
        const weight1 = team1.reduce((total, player) => total + getPlayerRating(player), 0);
        const weight2 = team2.reduce((total, player) => total + getPlayerRating(player), 0);
        const weightDiff = Math.abs(weight1 - weight2);
        if (weightDiff &lt; bestWeightDiff) {
            bestPairs = [[team1, team2]];
            bestWeightDiff = weightDiff;
        }
        else if (weightDiff === bestWeightDiff) {
            bestPairs.push([team1, team2]);
        }
    });
    shuffle(bestPairs);
    const bestPair = bestPairs.pop();
    logger.silly(`calcBalanceTeams done. ${bestPair.length}`);
    return bestPair;
};

const setTeams = lobbyOrState => async ([team1, team2]) => {
    const lobby = await getLobby(lobbyOrState);
    team1.forEach((player) => {
        // eslint-disable-next-line no-param-reassign
        player.LobbyPlayer = { faction: 1 };
    });
    team2.forEach((player) => {
        // eslint-disable-next-line no-param-reassign
        player.LobbyPlayer = { faction: 2 };
    });
    return lobby.setPlayers(team1.concat(team2), { through: { faction: 0 } });
};

const getPlayerRatingFunction = (matchmakingSystem) => {
    logger.silly(`getPlayerRatingFunction ${matchmakingSystem}`);
    switch (matchmakingSystem) {
    case 'elo':
        return player => player.rating;
    default:
        return player => player.rankTier;
    }
};

const selectCaptainPairFromTiers = captainRankThreshold => getPlayerRating => (tiers) => {
    const keys = Object.keys(tiers).sort();
    logger.silly(`selectCaptainPairFromTiers captainRankThreshold: ${captainRankThreshold} keys: ${keys}`);
    // loop through tiers. lower tier = higher priority
    for (const key of keys) {
        logger.silly(`selectCaptainPairFromTiers checking tier ${key}`);
        const tier = tiers[key];
        // only look at tiers with at least 2 players in them
        if (tier.length >= 2) {
            logger.silly(`selectCaptainPairFromTiers tier ${key} length >= 2`);
            // get all possible pairs within the tier
            let combs = combinations(tier, 2);

            logger.silly(`selectCaptainPairFromTiers combs ${combs.length}`);
            // filter out pairs that exceed skill difference threshold
            combs = combs.filter(([player1, player2]) => Math.abs(getPlayerRating(player1) - getPlayerRating(player2)) &lt;= captainRankThreshold);
            logger.silly(`selectCaptainPairFromTiers filtered combs ${combs.length}`);

            if (combs.length) {
                // select random pair
                shuffle(combs);
                logger.silly(`selectCaptainPairFromTiers shuffled combs ${combs.length}`);

                return combs.pop();
            }
        }
    }
    return [];
};

const sortPlayersByCaptainPriority = (playersWithCaptainPriority) => {
    const tiers = {};
    for (const [player, captainPriority] of playersWithCaptainPriority) {
        if (captainPriority &lt; Infinity) {
            tiers[captainPriority] = tiers[captainPriority] || [];
            tiers[captainPriority].push(player);
        }
    }
    logger.silly(`sortPlayersByCaptainPriority ${Object.keys(tiers)}`);
    return tiers;
};

const roleToCaptainPriority = regexp => (role) => {
    const match = role.name.match(regexp);
    return match ? parseInt(match[1]) : null;
};

const getCaptainPriorityFromRoles = (captainRoleRegexp, roles) => {
    const regexp = new RegExp(captainRoleRegexp);
    const priorities = roles.map(roleToCaptainPriority(regexp)).filter(Number.isFinite);
    logger.silly(`getCaptainPriorityFromRoles ${captainRoleRegexp} ${roles} ${priorities}`);
    return Math.min.apply(null, priorities);
};

const playerToCaptainPriority = guild => captainRoleRegexp => async player => [player, getCaptainPriorityFromRoles(captainRoleRegexp, await Guild.getUserRoles(guild)(player))];

const getPlayersWithCaptainPriority = guild => captainRoleRegexp => async lobbyOrState => mapPlayers(playerToCaptainPriority(guild)(captainRoleRegexp))(lobbyOrState);

const getActiveQueuersWithCaptainPriority = guild => captainRoleRegexp => async lobbyOrState => mapActiveQueuers(playerToCaptainPriority(guild)(captainRoleRegexp))(lobbyOrState);

const checkQueueForCaptains = async lobbyState => Fp.pipeP(
    getActiveQueuersWithCaptainPriority(lobbyState.inhouseState.guild)(lobbyState.inhouseState.captainRoleRegexp),
    sortPlayersByCaptainPriority,
    selectCaptainPairFromTiers(lobbyState.inhouseState.captainRankThreshold)(getPlayerRatingFunction(lobbyState.inhouseState.matchmakingSystem)),
)(lobbyState);

const assignCaptains = async lobbyState => Fp.pipeP(
    getPlayersWithCaptainPriority(lobbyState.inhouseState.guild)(lobbyState.inhouseState.captainRoleRegexp),
    sortPlayersByCaptainPriority,
    selectCaptainPairFromTiers(lobbyState.inhouseState.captainRankThreshold)(getPlayerRatingFunction(lobbyState.inhouseState.matchmakingSystem)),
)(lobbyState);

const calcDefaultGameMode = defaultGameMode => (gameModePreferences) => {
    const gameModeTotals = gameModePreferences.reduce((tally, gameModePreference) => ({
        ...tally,
        [gameModePreference]: (tally[gameModePreference] || 0) + 1,
    }), {});

    let bestGameMode = defaultGameMode;
    let bestCount = gameModeTotals[defaultGameMode] || 0;
    for (const [gameMode, count] of Object.entries(gameModeTotals)) {
        if (count > bestCount) {
            bestCount = count;
            bestGameMode = gameMode;
        }
    }

    logger.silly(`calcDefaultGameMode ${util.inspect(gameModeTotals)} ${bestCount} ${bestGameMode}`);
    return bestGameMode;
};

const autoBalanceTeams = getPlayerRating => async lobbyOrState => Fp.pipeP(
    getPlayers(),
    calcBalanceTeams(getPlayerRating),
    setTeams(lobbyOrState),
)(lobbyOrState);

const getDefaultGameMode = async lobbyState => Fp.pipeP(
    mapPlayers(player => player.gameModePreference),
    calcDefaultGameMode(lobbyState.inhouseState.defaultGameMode),
)(lobbyState);

const assignGameMode = async lobbyState => ({ ...lobbyState, gameMode: await getDefaultGameMode(lobbyState) });

const getDraftingFaction = draftOrder => async (lobbyOrState) => {
    const playersNoTeam = await getNoFactionPlayers()(lobbyOrState);
    const unassignedCount = playersNoTeam.length;
    if (unassignedCount === 0) {
        return 0;
    }
    logger.silly(`getDraftingFaction ${draftOrder}`);
    return draftOrder[draftOrder.length - unassignedCount] === 'A' ? lobbyOrState.playerFirstPick : 3 - lobbyOrState.playerFirstPick;
};

const getFactionCaptain = lobbyOrState => async faction => (faction > 0 &amp;&amp; faction &lt;= 2 ? getPlayerByUserId(lobbyOrState)([lobbyOrState.captain1UserId, lobbyOrState.captain2UserId][faction - 1]) : null);

const isPlayerDraftable = lobbyOrState => async (player) => {
    if (player.id === lobbyOrState.captain1UserId || player.id === lobbyOrState.captain2UserId) {
        return CONSTANTS.INVALID_DRAFT_CAPTAIN;
    }
    if (player.LobbyPlayer.faction !== 0) {
        return CONSTANTS.INVALID_DRAFT_PLAYER;
    }
    return CONSTANTS.PLAYER_DRAFTED;
};

const isCaptain = lobbyState => user => user.id === lobbyState.captain1UserId || user.id === lobbyState.captain2UserId;

const isFactionCaptain = lobbyState => faction => user => user.id === lobbyState[`captain${faction}UserId`];

const formatNameForLobby = input => input.replace(/[^0-9a-z]/gi, '').substring(0, 15);

const getLobbyNameFromCaptains = async (captainName1, captainName2, counter) => {
    const name1 = formatNameForLobby(captainName1);
    const name2 = formatNameForLobby(captainName2);
    const lobbyName = `${name1}-${name2}-${counter}`;
    const lobby = await Db.findLobbyByName(lobbyName);
    if (!lobby) {
        return lobbyName;
    }

    return getLobbyNameFromCaptains(captainName1, captainName2, counter + 1);
};

const resetLobbyState = async (_lobbyState) => {
    const lobbyState = { ..._lobbyState };
    switch (lobbyState.state) {
    case CONSTANTS.STATE_WAITING_FOR_PLAYERS:
    case CONSTANTS.STATE_BOT_STARTED:
        lobbyState.state = CONSTANTS.STATE_WAITING_FOR_BOT;
        logger.silly(`resetLobbyState ${_lobbyState.id} ${_lobbyState.state} to ${lobbyState.state}`);
        break;
    case CONSTANTS.STATE_CHECKING_READY:
        lobbyState.state = CONSTANTS.STATE_BEGIN_READY;
        logger.silly(`resetLobbyState ${_lobbyState.id} ${_lobbyState.state} to ${lobbyState.state}`);
        break;
    default:
        lobbyState.state = lobbyState.state || CONSTANTS.STATE_NEW;
        break;
    }
    await Db.updateLobby(lobbyState);
    return lobbyState;
};

const isReadyCheckTimedOut = lobbyState => Date.now() - lobbyState.readyCheckTime >= lobbyState.inhouseState.readyCheckTimeout;

const createLobbyState = inhouseState => ({ channel, role }) => lobby => ({
    inhouseState: { ...inhouseState },
    ...(lobby instanceof Sequelize.Model ? lobby.get({ plain: true }) : lobby),
    channel,
    role,
    channelId: channel.id,
    roleId: role.id,
});

const lobbyToLobbyState = inhouseState => async (lobby) => {
    let channel;
    let role;
    try {
        await lock.acquire(`lobby-${lobby.id}`, async () => {
            if (lobby.channelId) {
                channel = Guild.findChannel(inhouseState.guild)(lobby.channelId);
            }
            if (channel) {
                if (channel.name !== lobby.lobbyName) {
                    channel = await Guild.setChannelName(lobby.lobbyName)(channel);
                }
            }
            else {
                channel = await Guild.findOrCreateChannelInCategory(inhouseState.guild, inhouseState.category, lobby.lobbyName);
                await Db.updateLobbyChannel(lobby)(channel);
            }
        });
        await lock.acquire(`lobby-${lobby.id}`, async () => {
            if (lobby.roleId) {
                role = Guild.findRole(inhouseState.guild)(lobby.roleId);
            }
            if (role) {
                if (role.name !== lobby.lobbyName) {
                    role = await Fp.pipeP(
                        Guild.setRoleName(lobby.lobbyName),
                        Guild.setRolePermissions([]),
                        Guild.setRoleMentionable(true),
                    )(role);
                }
            }
            else {
                role = await Guild.makeRole(inhouseState.guild)([])(true)(lobby.lobbyName);
                await Db.updateLobbyRole(lobby)(role);
            }
        });
        const lobbyState = await createLobbyState(inhouseState)({ channel, role })(lobby);
        const badQueuers = await cleanMissingQueuers(lobbyState);
        const queuers = await getQueuers()(lobbyState);
        const badPlayers = await cleanMissingPlayers(lobbyState);
        const players = await getPlayers()(lobbyState);
        logger.silly(`lobbyToLobbyState ${lobby.id}, ${lobbyState.lobbyName}, ${queuers.length}, ${badQueuers.length}, ${players.length}, ${badPlayers.length}, ${lobbyState.captain1UserId}, ${lobbyState.captain2UserId}`);

        if ([CONSTANTS.STATE_NEW, CONSTANTS.STATE_WAITING_FOR_QUEUE].indexOf(lobbyState.state) !== -1) {
            await Guild.setChannelViewable(inhouseState.guild)(true)(channel);
        }
        else {
            await Guild.setChannelViewable(inhouseState.guild)(false)(channel);
            await Guild.setChannelViewableForRole(inhouseState.adminRole)(true)(channel);
            await Guild.setChannelViewableForRole(role)(true)(channel);
        }
        await addRoleToPlayers(lobbyState);
        return lobbyState;
    }
    catch (e) {
        logger.error(e);
        await Db.updateLobbyFailed(lobby)('lobbyToLobbyState: {e.toString()}');
        if (channel) {
            await channel.send('Lobby failed to load.');
            await Guild.setChannelViewable(inhouseState.guild)(false)(channel);
        }
        throw e;
    }
};

const forceLobbyDraft = async (_lobbyState, captain1, captain2) => {
    const lobbyState = { ..._lobbyState };
    const states = [
        CONSTANTS.STATE_ASSIGNING_CAPTAINS,
        CONSTANTS.STATE_SELECTION_PRIORITY,
        CONSTANTS.STATE_DRAFTING_PLAYERS,
        CONSTANTS.STATE_AUTOBALANCING,
        CONSTANTS.STATE_TEAMS_SELECTED,
        CONSTANTS.STATE_WAITING_FOR_BOT,
        CONSTANTS.STATE_BOT_ASSIGNED,
        CONSTANTS.STATE_BOT_STARTED,
        CONSTANTS.STATE_BOT_FAILED,
        CONSTANTS.STATE_WAITING_FOR_PLAYERS,
    ];
    if (states.indexOf(lobbyState.state) !== -1) {
        lobbyState.state = CONSTANTS.STATE_SELECTION_PRIORITY;
        lobbyState.selectionPriority = 0;
        lobbyState.playerFirstPick = 0;
        lobbyState.firstPick = 0;
        lobbyState.radiantFaction = 0;
        lobbyState.captain1UserId = captain1.id;
        lobbyState.captain2UserId = captain2.id;
    }
    return lobbyState;
};

const createChallengeLobby = async ({ inhouseState, captain1, captain2, challenge }) => {
    const captainMember1 = await Guild.resolveUser(inhouseState.guild)(captain1.discordId);
    const captainMember2 = await Guild.resolveUser(inhouseState.guild)(captain2.discordId);
    const lobbyName = await getLobbyNameFromCaptains(captainMember1.displayName, captainMember2.displayName, 1);
    const lobby = await Db.findOrCreateLobbyForGuild(inhouseState.guild.id, CONSTANTS.QUEUE_TYPE_CHALLENGE, lobbyName);
    await Db.setChallengeAccepted(challenge);
    await addQueuers(lobby)([captain1, captain2]);
    const lobbyState = await lobbyToLobbyState(inhouseState)(lobby);
    await Guild.setChannelPosition(1)(lobbyState.channel);
    lobbyState.captain1UserId = captain1.id;
    lobbyState.captain2UserId = captain2.id;
    await Db.updateLobby(lobbyState);
    return lobbyState;
};

const removeLobbyPlayersFromQueues = async lobbyOrState => mapPlayers(removeUserFromQueues)(lobbyOrState);

const assignLobbyName = async (lobbyState) => {
    let lobbyName = templateString(lobbyState.inhouseState.lobbyNameTemplate)({ lobbyId: lobbyState.id });
    lobbyName = lobbyName.toLowerCase().replace(/ /g, '-').replace(/[^0-9a-z-]/gi, '');
    return { ...lobbyState, lobbyName };
};

const reducePlayerToTeamCache = radiantFaction => (_teamCache, player) => {
    const teamCache = { ..._teamCache };
    teamCache[player.steamId64] = player.LobbyPlayer.faction === radiantFaction ? 1 : 2;
    return teamCache;
};

const createLobbyStateMessage = async (lobbyState) => {
    let topic = `Status: ${lobbyState.state.replace('STATE_', '').split('_').map(capitalize).join(' ')}.`;
    const queuers = await getActiveQueuers()(lobbyState);
    if (queuers.length) {
        topic += `\n${queuers.length} in queue: ${queuers.map(user => Guild.userToDisplayName(lobbyState.inhouseState.guild)(user)).join(', ')}.`;
    }
    const captains = [];
    if (lobbyState.captain1UserId) {
        captains.push(await Db.findUserById(lobbyState.captain1UserId));
    }
    if (lobbyState.captain2UserId) {
        captains.push(await Db.findUserById(lobbyState.captain2UserId));
    }
    if (captains.length) {
        topic += `\nCaptains: ${captains.map(user => Guild.userToDisplayName(lobbyState.inhouseState.guild)(user)).join(', ')}.`;
    }
    if (lobbyState.state === CONSTANTS.STATE_BEGIN_READY || lobbyState.state === CONSTANTS.STATE_CHECKING_READY) {
        const readyPlayers = await getReadyPlayers()(lobbyState);
        if (readyPlayers.length) {
            topic += `\n${readyPlayers.length} ready players: ${readyPlayers.map(user => Guild.userToDisplayName(lobbyState.inhouseState.guild)(user)).join(', ')}.`;
        }
        const notReadyPlayers = await getNotReadyPlayers()(lobbyState);
        if (notReadyPlayers.length) {
            topic += `\n${notReadyPlayers.length} players not ready: ${notReadyPlayers.map(user => Guild.userToDisplayName(lobbyState.inhouseState.guild)(user)).join(', ')}.`;
        }
    }
    if (lobbyState.state === CONSTANTS.STATE_DRAFTING_PLAYERS) {
        const playersNoTeam = await getNoFactionPlayers()(lobbyState);
        if (playersNoTeam.length) {
            topic += `\n${playersNoTeam.length} unpicked players: ${playersNoTeam.map(user => Guild.userToDisplayName(lobbyState.inhouseState.guild)(user)).join(', ')}.`;
        }
    }
    const radiant = await getRadiantPlayers()(lobbyState);
    if (radiant.length) {
        topic += `\nRadiant: ${radiant.map(user => Guild.userToDisplayName(lobbyState.inhouseState.guild)(user)).join(', ')}.`;
    }
    const dire = await getDirePlayers()(lobbyState);
    if (dire.length) {
        topic += `\nDire: ${dire.map(user => Guild.userToDisplayName(lobbyState.inhouseState.guild)(user)).join(', ')}.`;
    }
    if ([CONSTANTS.STATE_BOT_ASSIGNED,
        CONSTANTS.STATE_WAITING_FOR_BOT,
        CONSTANTS.STATE_BOT_STARTED,
        CONSTANTS.STATE_WAITING_FOR_PLAYERS].indexOf(lobbyState.state) !== -1) {
        topic += `\nLobby Name: ${lobbyState.lobbyName} Password: ${lobbyState.password}`;
    }
    return topic;
};

const setLobbyTopic = async (lobbyState) => {
    if (lobbyState.state === CONSTANTS.STATE_KILLED) return;
    if (!lobbyState.channel) return;
    const topic = await createLobbyStateMessage(lobbyState);
    await Guild.setChannelTopic(topic)(lobbyState.channel);
};

const assignBotToLobby = lobbyState => async (botId) => {
    await Db.assignBotToLobby(lobbyState)(botId);
    return { ...lobbyState, botId };
};

const unassignBotFromLobby = async (lobbyState) => {
    if (lobbyState.botId) {
        await Db.unassignBotFromLobby(lobbyState)(lobbyState.botId);
    }
    return { ...lobbyState, botId: null, dotaLobbyId: null };
};

module.exports = {
    getLobby,
    getPlayers,
    getPlayerByUserId,
    getPlayerBySteamId,
    getPlayerByDiscordId,
    getNoFactionPlayers,
    getFaction1Players,
    getFaction2Players,
    getRadiantPlayers,
    getDirePlayers,
    getNotReadyPlayers,
    getReadyPlayers,
    mapPlayers,
    addPlayer,
    removePlayer,
    addPlayers,
    addRoleToPlayers,
    updateLobbyPlayer,
    updateLobbyPlayerBySteamId,
    setPlayerReady,
    setPlayerFaction,
    sortQueuersAsc,
    getQueuers,
    getActiveQueuers,
    getQueuerByUserId,
    getQueuerBySteamId,
    getQueuerByDiscordId,
    mapQueuers,
    mapActiveQueuers,
    hasQueuer,
    addQueuer,
    removeQueuer,
    addQueuers,
    addRoleToQueuers,
    updateLobbyQueuer,
    updateLobbyQueuerBySteamId,
    setQueuerActive,
    removeUserFromQueues,
    removeQueuers,
    removePlayers,
    lobbyQueuerToPlayer,
    returnPlayerToQueue,
    returnPlayersToQueue,
    isUserInGuild,
    cleanMissingPlayers,
    cleanMissingQueuers,
    checkPlayers,
    validateLobbyPlayers,
    calcBalanceTeams,
    setTeams,
    getPlayerRatingFunction,
    selectCaptainPairFromTiers,
    sortPlayersByCaptainPriority,
    roleToCaptainPriority,
    getCaptainPriorityFromRoles,
    playerToCaptainPriority,
    getPlayersWithCaptainPriority,
    getActiveQueuersWithCaptainPriority,
    checkQueueForCaptains,
    assignCaptains,
    calcDefaultGameMode,
    autoBalanceTeams,
    getDefaultGameMode,
    assignGameMode,
    getDraftingFaction,
    getFactionCaptain,
    isPlayerDraftable,
    isCaptain,
    isFactionCaptain,
    formatNameForLobby,
    getLobbyNameFromCaptains,
    resetLobbyState,
    isReadyCheckTimedOut,
    createLobbyState,
    lobbyToLobbyState,
    createChallengeLobby,
    forceLobbyDraft,
    removeLobbyPlayersFromQueues,
    assignLobbyName,
    reducePlayerToTeamCache,
    createLobbyStateMessage,
    setLobbyTopic,
    assignBotToLobby,
    unassignBotFromLobby,
};
</code></pre>
        </article>
    </section>




</div>

<footer>
    <img class="logo" src="img/toast-ui.png" style="">
    <div class="footer-text">https://github.com/devilesk/dota-ihl-bot</div>
</footer>
<script>prettyPrint();</script>
<script src="scripts/jquery.min.js"></script>
<script src="scripts/tui-doc.js"></script>
<script src="scripts/linenumber.js"></script>

    <script>
        var id = '_sub'.replace(/"/g, '_');
        var selectedApi = document.getElementById(id); // do not use jquery selector
        var $selectedApi = $(selectedApi);

        $selectedApi.removeClass('hidden');
        $selectedApi.parent().find('.glyphicon').removeClass('glyphicon-plus').addClass('glyphicon-minus');
        showLnbApi();
    </script>

</body>
</html>
