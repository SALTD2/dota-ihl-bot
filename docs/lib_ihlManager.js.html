

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Source: lib/ihlManager.js | dota-ihl-bot</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-jsdoc.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/tui-doc.css">

    
</head>
<body>
<nav class="lnb" id="lnb">
    <div class="logo" style="">
        
            <img src="img/toast-ui.png" width="100%" height="100%">
        
    </div>
    <div class="title">
        <h1><a href="index.html" class="link">dota-ihl-bot</a></h1>
        
            <span class="version">v0.1.0</span>
        
    </div>
    <div class="search-container" id="search-container">
        <input type="text" placeholder="Search">
        <ul></ul>
    </div>
    
    <div class="lnb-api hidden"><h3>Modules</h3><ul><li><a href="module-constants.html">constants</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:constants_sub"></div></li><li><a href="module-db.html">db</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:db_sub"></div></li><li><a href="module-dotaBot.html">dotaBot</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:dotaBot_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-dotaBot.html#~isDotaLobbyReady">isDotaLobbyReady</a></li><li><a href="module-dotaBot.html#~slotToTeam">slotToTeam</a></li><li><a href="module-dotaBot.html#~startDotaLobby">startDotaLobby</a></li><li><a href="module-dotaBot.html#~updatePlayerState">updatePlayerState</a></li></ul><div class="member-type">Typedef</div><ul class="inner"><li><a href="module-dotaBot.html#.LogOnDetails">LogOnDetails</a></li></ul></div></li><li><a href="module-guild.html">guild</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:guild_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-guild.html#~resolveRole">resolveRole</a></li><li><a href="module-guild.html#~resolveUser">resolveUser</a></li></ul></div></li><li><a href="module-ihl.html">ihl</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:ihl_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-ihl.html#~banInhouseQueue">banInhouseQueue</a></li><li><a href="module-ihl.html#~createInhouseState">createInhouseState</a></li><li><a href="module-ihl.html#~getAllLobbyQueues">getAllLobbyQueues</a></li><li><a href="module-ihl.html#~getAllLobbyQueuesForUser">getAllLobbyQueuesForUser</a></li><li><a href="module-ihl.html#~getUserRankTier">getUserRankTier</a></li><li><a href="module-ihl.html#~hasActiveLobbies">hasActiveLobbies</a></li><li><a href="module-ihl.html#~joinLobbyQueue">joinLobbyQueue</a></li><li><a href="module-ihl.html#~leaveLobbyQueue">leaveLobbyQueue</a></li><li><a href="module-ihl.html#~registerUser">registerUser</a></li></ul><div class="member-type">Typedef</div><ul class="inner"><li><a href="module-ihl.html#.InhouseState">InhouseState</a></li><li><a href="module-ihl.html#.LeagueGuildObject">LeagueGuildObject</a></li></ul></div></li><li><a href="module-ihlManager.html">ihlManager</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:ihlManager_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-ihlManager.html#~findUser">findUser</a></li><li><a href="module-ihlManager.html#~loadInhouseStates">loadInhouseStates</a></li><li><a href="module-ihlManager.html#~loadInhouseStatesFromLeagues">loadInhouseStatesFromLeagues</a></li></ul><div class="member-type">Events</div><ul class="inner"><li><a href="module-ihlManager.html#~event:empty">empty</a></li><li><a href="module-ihlManager.html#~event:EVENT_GUILD_MESSAGE">EVENT_GUILD_MESSAGE</a></li><li><a href="module-ihlManager.html#~event:EVENT_GUILD_USER_LEFT">EVENT_GUILD_USER_LEFT</a></li><li><a href="module-ihlManager.html#~event:EVENT_LOBBY_FORCE_DRAFT">EVENT_LOBBY_FORCE_DRAFT</a></li><li><a href="module-ihlManager.html#~event:EVENT_PICK_PLAYER">EVENT_PICK_PLAYER</a></li><li><a href="module-ihlManager.html#~event:EVENT_PLAYER_READY">EVENT_PLAYER_READY</a></li><li><a href="module-ihlManager.html#~event:EVENT_RUN_LOBBY">EVENT_RUN_LOBBY</a></li><li><a href="module-ihlManager.html#~event:ready">ready</a></li></ul><div class="member-type">Typedef</div><ul class="inner"><li><a href="module-ihlManager.html#~eventCallback">eventCallback</a></li></ul></div></li><li><a href="module-lobby.html">lobby</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:lobby_sub"><div class="member-type">Typedef</div><ul class="inner"><li><a href="module-lobby.html#.LobbyState">LobbyState</a></li></ul></div></li><li><a href="module-matchTracker.html">matchTracker</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:matchTracker_sub"></div></li></ul></div><div class="lnb-api hidden"><h3>Externals</h3><ul><li><a href="external-commando.html">commando</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="external:commando_sub"></div></li><li><a href="external-discordjs.html">discordjs</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="external:discordjs_sub"></div></li><li><a href="external-Dota2.html">Dota2</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="external:Dota2_sub"></div></li><li><a href="external-EventEmitter.html">EventEmitter</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="external:EventEmitter_sub"></div></li><li><a href="external-Long.html">Long</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="external:Long_sub"></div></li><li><a href="external-sequelize.html">sequelize</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="external:sequelize_sub"></div></li><li><a href="external-steam.html">steam</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="external:steam_sub"></div></li></ul></div><div class="lnb-api hidden"><h3>Classes</h3><ul><li><a href="BotAddCommand.html">BotAddCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="BotAddCommand_sub"></div></li><li><a href="BotListCommand.html">BotListCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="BotListCommand_sub"></div></li><li><a href="BotRemoveCommand.html">BotRemoveCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="BotRemoveCommand_sub"></div></li><li><a href="BotStatusCommand.html">BotStatusCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="BotStatusCommand_sub"></div></li><li><a href="ChallengeCommand.html">ChallengeCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="ChallengeCommand_sub"></div></li><li><a href="ChallengeListCommand.html">ChallengeListCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="ChallengeListCommand_sub"></div></li><li><a href="CommendCommand.html">CommendCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="CommendCommand_sub"></div></li><li><a href="DireCommand.html">DireCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="DireCommand_sub"></div></li><li><a href="external-discordjs.CategoryChannel.html">CategoryChannel</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="external:discordjs.CategoryChannel_sub"></div></li><li><a href="external-discordjs.Client.html">Client</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="external:discordjs.Client_sub"></div></li><li><a href="external-discordjs.Guild.html">Guild</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="external:discordjs.Guild_sub"></div></li><li><a href="external-discordjs.GuildChannel.html">GuildChannel</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="external:discordjs.GuildChannel_sub"></div></li><li><a href="external-discordjs.GuildMember.html">GuildMember</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="external:discordjs.GuildMember_sub"></div></li><li><a href="external-discordjs.Message.html">Message</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="external:discordjs.Message_sub"></div></li><li><a href="external-discordjs.Role.html">Role</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="external:discordjs.Role_sub"></div></li><li><a href="external-discordjs.User.html">User</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="external:discordjs.User_sub"></div></li><li><a href="external-sequelize.Model.html">Model</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="external:sequelize.Model_sub"></div></li><li><a href="FirstCommand.html">FirstCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="FirstCommand_sub"></div></li><li><a href="GameModeCommand.html">GameModeCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="GameModeCommand_sub"></div></li><li><a href="IHLCommand.html">IHLCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="IHLCommand_sub"></div></li><li><a href="InviteCommand.html">InviteCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="InviteCommand_sub"></div></li><li><a href="InviteUrlCommand.html">InviteUrlCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="InviteUrlCommand_sub"></div></li><li><a href="LeaderboardCommand.html">LeaderboardCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="LeaderboardCommand_sub"></div></li><li><a href="LeagueCreateCommand.html">LeagueCreateCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="LeagueCreateCommand_sub"></div></li><li><a href="LeagueInfoCommand.html">LeagueInfoCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="LeagueInfoCommand_sub"></div></li><li><a href="LeagueSeasonCommand.html">LeagueSeasonCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="LeagueSeasonCommand_sub"></div></li><li><a href="LeagueTicketCommand.html">LeagueTicketCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="LeagueTicketCommand_sub"></div></li><li><a href="LeagueUpdateCommand.html">LeagueUpdateCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="LeagueUpdateCommand_sub"></div></li><li><a href="LobbyDraftCommand.html">LobbyDraftCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="LobbyDraftCommand_sub"></div></li><li><a href="LobbyFirstPickCommand.html">LobbyFirstPickCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="LobbyFirstPickCommand_sub"></div></li><li><a href="LobbyGameModeCommand.html">LobbyGameModeCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="LobbyGameModeCommand_sub"></div></li><li><a href="LobbyInviteCommand.html">LobbyInviteCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="LobbyInviteCommand_sub"></div></li><li><a href="LobbyKickCommand.html">LobbyKickCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="LobbyKickCommand_sub"></div></li><li><a href="LobbyKillCommand.html">LobbyKillCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="LobbyKillCommand_sub"></div></li><li><a href="LobbyRunCommand.html">LobbyRunCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="LobbyRunCommand_sub"></div></li><li><a href="LobbyStartCommand.html">LobbyStartCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="LobbyStartCommand_sub"></div></li><li><a href="LobbyStateCommand.html">LobbyStateCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="LobbyStateCommand_sub"></div></li><li><a href="LobbySwapCommand.html">LobbySwapCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="LobbySwapCommand_sub"></div></li><li><a href="LogLevelCommand.html">LogLevelCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="LogLevelCommand_sub"></div></li><li><a href="module-db.Bot.html">Bot</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:db.Bot_sub"></div></li><li><a href="module-db.BotTicket.html">BotTicket</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:db.BotTicket_sub"></div></li><li><a href="module-db.Challenge.html">Challenge</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:db.Challenge_sub"></div></li><li><a href="module-db.Commend.html">Commend</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:db.Commend_sub"></div></li><li><a href="module-db.Database.html">Database</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:db.Database_sub"></div></li><li><a href="module-db.Leaderboard.html">Leaderboard</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:db.Leaderboard_sub"></div></li><li><a href="module-db.League.html">League</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:db.League_sub"></div></li><li><a href="module-db.LeagueTicket.html">LeagueTicket</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:db.LeagueTicket_sub"></div></li><li><a href="module-db.Lobby.html">Lobby</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:db.Lobby_sub"></div></li><li><a href="module-db.LobbyPlayer.html">LobbyPlayer</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:db.LobbyPlayer_sub"></div></li><li><a href="module-db.LobbyQueuer.html">LobbyQueuer</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:db.LobbyQueuer_sub"></div></li><li><a href="module-db.Queue.html">Queue</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:db.Queue_sub"></div></li><li><a href="module-db.Reputation.html">Reputation</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:db.Reputation_sub"></div></li><li><a href="module-db.Season.html">Season</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:db.Season_sub"></div></li><li><a href="module-db.Ticket.html">Ticket</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:db.Ticket_sub"></div></li><li><a href="module-db.User.html">User</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:db.User_sub"></div></li><li><a href="module-dotaBot-DotaBot.html">DotaBot</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:dotaBot~DotaBot_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="module-dotaBot-DotaBot.html#accountId">accountId</a></li><li><a href="module-dotaBot-DotaBot.html#backoff">backoff</a></li><li><a href="module-dotaBot-DotaBot.html#backoff">backoff</a></li><li><a href="module-dotaBot-DotaBot.html#dotaLobbyId">dotaLobbyId</a></li><li><a href="module-dotaBot-DotaBot.html#lobby">lobby</a></li><li><a href="module-dotaBot-DotaBot.html#lobbyChannelName">lobbyChannelName</a></li><li><a href="module-dotaBot-DotaBot.html#playerState">playerState</a></li><li><a href="module-dotaBot-DotaBot.html#rateLimit">rateLimit</a></li><li><a href="module-dotaBot-DotaBot.html#rateLimit">rateLimit</a></li><li><a href="module-dotaBot-DotaBot.html#state">state</a></li><li><a href="module-dotaBot-DotaBot.html#steamId64">steamId64</a></li><li><a href="module-dotaBot-DotaBot.html#teamCache">teamCache</a></li><li><a href="module-dotaBot-DotaBot.html#teamCache">teamCache</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="module-dotaBot-DotaBot.html#connect">connect</a></li><li><a href="module-dotaBot-DotaBot.html#disconnect">disconnect</a></li><li><a href="module-dotaBot-DotaBot.html#inviteToLobby">inviteToLobby</a></li><li><a href="module-dotaBot-DotaBot.html#joinPracticeLobby">joinPracticeLobby</a></li><li><a href="module-dotaBot-DotaBot.html#practiceLobbyKick">practiceLobbyKick</a></li><li><a href="module-dotaBot-DotaBot.html#practiceLobbyKickFromTeam">practiceLobbyKickFromTeam</a></li><li><a href="module-dotaBot-DotaBot.html#schedule">schedule</a></li></ul></div></li><li><a href="module-ihlManager-IHLManager.html">IHLManager</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:ihlManager~IHLManager_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-ihlManager-IHLManager.html#attachListeners">attachListeners</a></li><li><a href="module-ihlManager-IHLManager.html#banInhouseQueue">banInhouseQueue</a></li><li><a href="module-ihlManager-IHLManager.html#botLeaveLobby">botLeaveLobby</a></li><li><a href="module-ihlManager-IHLManager.html#clearAllLobbyQueues">clearAllLobbyQueues</a></li><li><a href="module-ihlManager-IHLManager.html#clearLobbyQueue">clearLobbyQueue</a></li><li><a href="module-ihlManager-IHLManager.html#createChallengeLobby">createChallengeLobby</a></li><li><a href="module-ihlManager-IHLManager.html#createNewLeague">createNewLeague</a></li><li><a href="module-ihlManager-IHLManager.html#getBot">getBot</a></li><li><a href="module-ihlManager-IHLManager.html#init">init</a></li><li><a href="module-ihlManager-IHLManager.html#joinAllLobbyQueues">joinAllLobbyQueues</a></li><li><a href="module-ihlManager-IHLManager.html#joinLobbyQueue">joinLobbyQueue</a></li><li><a href="module-ihlManager-IHLManager.html#leaveAllLobbyQueues">leaveAllLobbyQueues</a></li><li><a href="module-ihlManager-IHLManager.html#leaveLobbyQueue">leaveLobbyQueue</a></li><li><a href="module-ihlManager-IHLManager.html#loadBot">loadBot</a></li><li><a href="module-ihlManager-IHLManager.html#onBotAvailable">onBotAvailable</a></li><li><a href="module-ihlManager-IHLManager.html#onClientReady">onClientReady</a></li><li><a href="module-ihlManager-IHLManager.html#onCreateLobbyQueue">onCreateLobbyQueue</a></li><li><a href="module-ihlManager-IHLManager.html#onDiscordMemberLeave">onDiscordMemberLeave</a></li><li><a href="module-ihlManager-IHLManager.html#onDiscordMessage">onDiscordMessage</a></li><li><a href="module-ihlManager-IHLManager.html#onDraftMember">onDraftMember</a></li><li><a href="module-ihlManager-IHLManager.html#onforceLobbyDraft">onforceLobbyDraft</a></li><li><a href="module-ihlManager-IHLManager.html#onLeagueTicketAdd">onLeagueTicketAdd</a></li><li><a href="module-ihlManager-IHLManager.html#onLeagueTicketRemove">onLeagueTicketRemove</a></li><li><a href="module-ihlManager-IHLManager.html#onLeagueTicketSet">onLeagueTicketSet</a></li><li><a href="module-ihlManager-IHLManager.html#onLobbyInvite">onLobbyInvite</a></li><li><a href="module-ihlManager-IHLManager.html#onLobbyKick">onLobbyKick</a></li><li><a href="module-ihlManager-IHLManager.html#onLobbyKill">onLobbyKill</a></li><li><a href="module-ihlManager-IHLManager.html#onLobbyReady">onLobbyReady</a></li><li><a href="module-ihlManager-IHLManager.html#onLobbyTimedOut">onLobbyTimedOut</a></li><li><a href="module-ihlManager-IHLManager.html#onMatchNoStats">onMatchNoStats</a></li><li><a href="module-ihlManager-IHLManager.html#onMatchOutcome">onMatchOutcome</a></li><li><a href="module-ihlManager-IHLManager.html#onMatchSignedOut">onMatchSignedOut</a></li><li><a href="module-ihlManager-IHLManager.html#onMatchStats">onMatchStats</a></li><li><a href="module-ihlManager-IHLManager.html#onPlayerReady">onPlayerReady</a></li><li><a href="module-ihlManager-IHLManager.html#onSelectionPick">onSelectionPick</a></li><li><a href="module-ihlManager-IHLManager.html#onSelectionSide">onSelectionSide</a></li><li><a href="module-ihlManager-IHLManager.html#onSetBotStatus">onSetBotStatus</a></li><li><a href="module-ihlManager-IHLManager.html#onSetLobbyState">onSetLobbyState</a></li><li><a href="module-ihlManager-IHLManager.html#onStartDotaLobby">onStartDotaLobby</a></li><li><a href="module-ihlManager-IHLManager.html#processEventQueue">processEventQueue</a></li><li><a href="module-ihlManager-IHLManager.html#queueEvent">queueEvent</a></li><li><a href="module-ihlManager-IHLManager.html#registerLobbyTimeout">registerLobbyTimeout</a></li><li><a href="module-ihlManager-IHLManager.html#removeBot">removeBot</a></li><li><a href="module-ihlManager-IHLManager.html#runLobbiesForInhouse">runLobbiesForInhouse</a></li><li><a href="module-ihlManager-IHLManager.html#runLobby">runLobby</a></li><li><a href="module-ihlManager-IHLManager.html#unregisterLobbyTimeout">unregisterLobbyTimeout</a></li></ul></div></li><li><a href="module-matchTracker-MatchTracker.html">MatchTracker</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:matchTracker~MatchTracker_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-matchTracker-MatchTracker.html#disable">disable</a></li><li><a href="module-matchTracker-MatchTracker.html#enable">enable</a></li><li><a href="module-matchTracker-MatchTracker.html#run">run</a></li></ul></div></li><li><a href="NicknameCommand.html">NicknameCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="NicknameCommand_sub"></div></li><li><a href="PickCommand.html">PickCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="PickCommand_sub"></div></li><li><a href="Queue.html">Queue</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Queue_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="Queue.html#.State">State</a></li><li><a href="Queue.html#backoff">backoff</a></li><li><a href="Queue.html#backoff">backoff</a></li><li><a href="Queue.html#rateLimit">rateLimit</a></li><li><a href="Queue.html#rateLimit">rateLimit</a></li><li><a href="Queue.html#state">state</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="Queue.html#block">block</a></li><li><a href="Queue.html#clear">clear</a></li><li><a href="Queue.html#release">release</a></li><li><a href="Queue.html#schedule">schedule</a></li></ul></div></li><li><a href="QueueBanCommand.html">QueueBanCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="QueueBanCommand_sub"></div></li><li><a href="QueueClearCommand.html">QueueClearCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="QueueClearCommand_sub"></div></li><li><a href="QueueJoinCommand.html">QueueJoinCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="QueueJoinCommand_sub"></div></li><li><a href="QueueLeaveCommand.html">QueueLeaveCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="QueueLeaveCommand_sub"></div></li><li><a href="QueueReadyCommand.html">QueueReadyCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="QueueReadyCommand_sub"></div></li><li><a href="QueueStatusCommand.html">QueueStatusCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="QueueStatusCommand_sub"></div></li><li><a href="RadiantCommand.html">RadiantCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="RadiantCommand_sub"></div></li><li><a href="RegisterCommand.html">RegisterCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="RegisterCommand_sub"></div></li><li><a href="RepCommand.html">RepCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="RepCommand_sub"></div></li><li><a href="RestartCommand.html">RestartCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="RestartCommand_sub"></div></li><li><a href="RolesCommand.html">RolesCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="RolesCommand_sub"></div></li><li><a href="SecondCommand.html">SecondCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="SecondCommand_sub"></div></li><li><a href="TicketAddCommand.html">TicketAddCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="TicketAddCommand_sub"></div></li><li><a href="TicketRemoveCommand.html">TicketRemoveCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="TicketRemoveCommand_sub"></div></li><li><a href="UnchallengeCommand.html">UnchallengeCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="UnchallengeCommand_sub"></div></li><li><a href="UncommendCommand.html">UncommendCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="UncommendCommand_sub"></div></li><li><a href="UnrepCommand.html">UnrepCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="UnrepCommand_sub"></div></li><li><a href="UserBadgeCommand.html">UserBadgeCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="UserBadgeCommand_sub"></div></li><li><a href="UserVouchCommand.html">UserVouchCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="UserVouchCommand_sub"></div></li><li><a href="WhoisCommand.html">WhoisCommand</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="WhoisCommand_sub"></div></li></ul></div><div class="lnb-api hidden"><h3>Global</h3><ul><li><a href="global.html#cache">cache</a></li><li><a href="global.html#shuffle">shuffle</a></li></ul></div>
</nav>
<div id="resizer"></div>

<div class="main" id="main">
    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/* eslint-disable class-methods-use-this */
/**
 * @module ihlManager
 */

/**
 * Node.js EventEmitter object
 * @external EventEmitter
 * @see {@link https://nodejs.org/api/events.html#events_class_eventemitter}
 */

const Dota2 = require('dota2');
const assert = require('assert').strict;
const Commando = require('discord.js-commando');
const Permissions = require('discord.js/src/util/Permissions.js');
const Promise = require('bluebird');
const { EventEmitter } = require('events');
const path = require('path');
const util = require('util');
const logger = require('./logger');
const MatchTracker = require('./matchTracker');
const CONSTANTS = require('./constants');
const Db = require('./db');
const Lobby = require('./lobby');
const Ihl = require('./ihl');
const Fp = require('./util/fp');
const equalsLong = require('./util/equalsLong');
const Guild = require('./guild');
const DotaBot = require('./dotaBot');
const LobbyStateHandlers = require('./lobbyStateHandlers');
const LobbyQueueHandlers = require('./lobbyQueueHandlers');
const EventListeners = require('./eventListeners');
const MessageListeners = require('./messageListeners');

/**
* Searches the discord guild for a member.
* @function
* @param {external:Guild} guild - A list of guilds to initialize leagues with.
* @param {string|external:GuildMember} member - A name or search string for an inhouse player or their guild member instance.
* @returns {Array} The search result in an array containing the user record, discord guild member, and type of match.
*/
const findUser = guild => async (member) => {
    let discordId;
    let discorduser;
    let user;
    let resultType;
    const discordIdMatches = `${member}`.match(/&lt;@!?(\d+)>/);
    logger.silly(`findUser ${util.inspect(member)} ${discordIdMatches}`);
    if (discordIdMatches) {
        discordId = discordIdMatches[1];
        discorduser = guild.members.get(discordId);
        user = await Db.findUserByDiscordId(guild.id)(discordId);
        resultType = CONSTANTS.MATCH_EXACT_DISCORD_MENTION;
    }
    else {
        // check exact discord displayName match
        discorduser = guild.members.find(guildMember => guildMember.displayName.toLowerCase() === member.toLowerCase());
        if (discorduser) {
            logger.silly(`findUser matched on displayName exact ${member.toLowerCase()}`);
            discordId = discorduser.id;
            user = await Db.findUserByDiscordId(guild.id)(discordId);
            resultType = CONSTANTS.MATCH_EXACT_DISCORD_NAME;
        }
        else {
            // check exact discord username match
            discorduser = guild.members.find(guildMember => guildMember.user.username.toLowerCase() === member.toLowerCase());
            if (discorduser) {
                logger.silly(`findUser matched on username exact ${member.toLowerCase()}`);
                discordId = discorduser.id;
                user = await Db.findUserByDiscordId(guild.id)(discordId);
                resultType = CONSTANTS.MATCH_EXACT_DISCORD_NAME;
            }
            else {
                // check exact nickname match
                user = await Db.findUserByNickname(guild.id)(member);
                if (user) {
                    logger.silly(`findUser matched on user nickname exact ${user.nickname}`);
                    discordId = user.discordId;
                    discorduser = guild.members.get(discordId);
                    resultType = CONSTANTS.MATCH_EXACT_NICKNAME;
                }
                else {
                    // try to parse a steamId64 from text
                    const steamId64 = await Ihl.parseSteamID64(member);
                    if (steamId64 != null) {
                        user = await Db.findUserBySteamId64(guild.id)(steamId64);
                        logger.silly(`findUser matched on steamId64 ${steamId64} ${user}`);
                    }
                    if (user) {
                        discorduser = guild.members.get(user.discordId);
                        resultType = CONSTANTS.MATCH_STEAMID_64;
                    }
                    else {
                        // check close nickname match
                        try {
                            [user] = await Db.findUserByNicknameLevenshtein(guild.id)(member);
                            if (user) {
                                logger.silly(`findUser matched on user nickname approximate ${user.nickname}`);
                                discordId = user.discordId;
                                discorduser = guild.members.get(discordId);
                                resultType = CONSTANTS.MATCH_CLOSEST_NICKNAME;
                            }
                        }
                        catch (e) {
                            logger.error(e);
                        }
                    }
                }
            }
        }
    }
    logger.silly(`findUser ${user ? user.id : null} ${discorduser ? discorduser.id : null} ${resultType}`);
    if (user &amp;&amp; discorduser) {
        return [user, discorduser, resultType];
    }
    logger.silly('findUser not found');
    return [null, null, null];
};

/**
* Maps league records to inhouse states.
* @function
* @async
* @param {external:Guild[]} guilds - A list of guilds to initialize leagues with.
* @param {module:db.League[]} leagues - A list of database league records.
* @returns {module:ihl.InhouseState[]} The inhouse states loaded from league records.
*/
const loadInhouseStates = guilds => async leagues => Fp.mapPromise(Ihl.createInhouseState)(leagues.map(league => ({ league, guild: guilds.get(league.guildId) })).filter(o => o.guild));

/**
* Gets all league records from the database turns them into inhouse states.
* @function
* @async
* @param {external:Guild[]} guilds - A list of guilds to initialize leagues with.
* @returns {module:ihl.InhouseState[]} The inhouse states loaded from all league records.
*/
const loadInhouseStatesFromLeagues = async guilds => Fp.pipeP(
    Db.findAllLeagues,
    loadInhouseStates(guilds),
)();

const createClient = options => new Commando.CommandoClient({
    commandPrefix: options.COMMAND_PREFIX || '!',
    owner: options.OWNER_DISCORD_ID,
    disableEveryone: true,
    commandEditableDuration: 0,
    unknownCommandResponse: false,
});

const setMatchPlayerDetails = matchOutcome => members => async (_lobby) => {
    const lobby = await Lobby.getLobby(_lobby);
    const players = await Lobby.getPlayers()(lobby);
    let winner = 0;
    const tasks = [];
    for (const playerData of members) {
        const steamId64 = playerData.id.toString();
        const player = players.find(p => p.steamId64 === steamId64);
        if (player) {
            const data = {
                win: 0,
                lose: 0,
                heroId: playerData.hero_id,
                kills: 0,
                deaths: 0,
                assists: 0,
                gpm: 0,
                xpm: 0,
            };
            if (((playerData.team === Dota2.schema.DOTA_GC_TEAM.DOTA_GC_TEAM_GOOD_GUYS)
                 &amp;&amp; (matchOutcome === Dota2.schema.EMatchOutcome.k_EMatchOutcome_RadVictory))
                || ((playerData.team === Dota2.schema.DOTA_GC_TEAM.DOTA_GC_TEAM_BAD_GUYS)
                 &amp;&amp; (matchOutcome === Dota2.schema.EMatchOutcome.k_EMatchOutcome_DireVictory))) {
                data.win = 1;
                winner = player.LobbyPlayer.faction;
            }
            else {
                data.lose = 1;
            }
            tasks.push(Lobby.updateLobbyPlayerBySteamId(data)(_lobby)(steamId64));
        }
    }
    await Fp.allPromise(tasks);
    await Db.updateLobbyWinner(lobby)(winner);
};

class IHLManager extends EventEmitter {
    /**
     * Creates an inhouse league manager.
     * @classdesc Class representing the inhouse league manager.
     */
    constructor(options) {
        super();

        this.options = options;
        this.client = null;
        this.lobbyTimeoutTimers = {};
        this.bots = {};
        this.matchTracker = null;
        this.attachListeners();
        this.eventQueue = [];
        this.blocking = false;
        this._runningLobby = false;
    }

    static get botPermissions() {
        return [
            'MANAGE_ROLES',
            'MANAGE_CHANNELS',
            'VIEW_CHANNEL',
            'SEND_MESSAGES',
            'EMBED_LINKS',
        ];
    }

    static get inviteUrl() {
        // eslint-disable-next-line no-bitwise
        return `https://discordapp.com/oauth2/authorize/?permissions=${IHLManager.botPermissions.reduce((all, p) => all | Permissions.FLAGS[p], 0)}&amp;scope=bot&amp;client_id=${process.env.CLIENT_ID}`;
    }

    /**
     * Initializes the inhouse league manager with a discord client and loads inhouse states for each league.
     * @async
     * @param {external:Client} client - A discord.js client.
     */
    async init(client) {
        logger.debug(`ihlManager init ${this.options.COMMAND_PREFIX}`);
        this.matchTracker = new MatchTracker.MatchTracker(parseInt(this.options.MATCH_POLL_INTERVAL || 5000));
        this.matchTracker.on(CONSTANTS.EVENT_MATCH_STATS, lobby => this.emit(CONSTANTS.EVENT_MATCH_STATS, lobby));
        this.matchTracker.on(CONSTANTS.EVENT_MATCH_NO_STATS, lobby => this.emit(CONSTANTS.EVENT_MATCH_NO_STATS, lobby));
        this.client = client;
        this.client.ihlManager = this;
        this.client.registry
            .registerDefaultTypes()
            .registerGroups([
                ['ihl', 'Inhouse League General Commands'],
                ['queue', 'Inhouse League Queue Commands'],
                ['challenge', 'Inhouse League Challenge Commands'],
                ['admin', 'Inhouse League Admin Commands'],
                ['owner', 'Bot Owner Commands'],
            ])
            .registerDefaultGroups()
            .registerDefaultCommands()
            .registerCommandsIn(path.join(__dirname, '../commands'));
        this.client.on('message', this.onDiscordMessage.bind(this));
        this.client.on('guildMemberRemove', this.onDiscordMemberLeave.bind(this));
        this.client.on('commandError', (cmd, err) => {
            if (err instanceof Commando.FriendlyError) return;
            logger.error(err);
        });
        return new Promise((resolve, reject) => {
            try {
                this.client.on('ready', async () => {
                    await this.onClientReady();
                    resolve();
                });
                this.client.login(this.options.TOKEN);
            }
            catch (e) {
                logger.error(e);
                reject(e);
            }
        });
    }

    get guilds() {
        return this.client.guilds.filter(guild => guild.me.hasPermission(IHLManager.botPermissions));
    }

    /**
    * Discord client ready handler.
    * @async
    * @fires module:ihlManager~ready
    */
    async onClientReady() {
        logger.debug(`ihlManager onClientReady logged in as ${this.client.user.tag}`);
        await Db.setAllBotsOffline();
        const inhouseStates = await loadInhouseStatesFromLeagues(this.guilds);
        logger.silly('ihlManager inhouseStates loaded');
        await Fp.mapPromise(Ihl.createLobbiesFromQueues)(inhouseStates);
        logger.silly('ihlManager created lobbies from queues');
        await Fp.mapPromise(this.runLobbiesForInhouse.bind(this))(inhouseStates);
        await this.matchTracker.loadLobbies();
        this.matchTracker.run();
        logger.debug('ihlManager onClientReady lobbies loaded and run.');
        this.emit('ready');
    }

    /**
    * Discord message handler.
    * @async
    * @param {external:discordjs.Message}  msg - The discord message.
    * @fires module:ihlManager~EVENT_GUILD_MESSAGE
    */
    async onDiscordMessage(msg) {
        if (msg.author.id !== this.client.user.id) {
            logger.silly(`ihlManager onDiscordMessage ${msg.channel.guild} ${msg.channel.id} ${msg.author.id} ${msg.content}`);
            if (msg.channel.guild) {
                this.emit(CONSTANTS.EVENT_GUILD_MESSAGE, msg);
            }
        }
    }

    /**
    * Discord user left guild handler.
    * @async
    * @param {external:discordjs.GuildMember} member - The member that left.
    * @fires module:ihlManager~EVENT_GUILD_USER_LEFT
    */
    async onDiscordMemberLeave(member) {
        logger.debug(`ihlManager onDiscordMemberLeave ${member}`);
        const user = await Db.findUserByDiscordId(member.guild.id)(member.id);
        if (user) {
            this.emit(CONSTANTS.EVENT_GUILD_USER_LEFT, user);
        }
    }

    /**
     * Creates a new inhouse in a discord guild.
     * @async
     * @param {external:discordjs.Guild} guild - The discord guild for the inhouse.
     */
    async createNewLeague(guild) {
        logger.debug(`ihlManager createNewLeague ${guild.id}`);
        const inhouseState = await Ihl.createNewLeague(guild);
        await Ihl.createLobbiesFromQueues(inhouseState);
        await this.runLobbiesForInhouse(inhouseState);
    }

    /**
     * Creates and runs a challenge lobby.
     * @async
     * @param {module:ihl.inhouseState} inhouseState - The inhouse state.
     * @param {module:db.User} captain1 - The first lobby captain.
     * @param {module:db.User} captain2 - The second lobby captain.
     * @param {module:db.Challenge} challenge - The challenge between the two captains.
     * @fires module:ihlManager~EVENT_RUN_LOBBY
     */
    async createChallengeLobby(inhouseState, captain1, captain2, challenge) {
        logger.debug(`ihlManager createChallengeLobby ${inhouseState.guild.id} ${captain1.id} ${captain2.id}`);
        const lobbyState = await Lobby.createChallengeLobby({ inhouseState, captain1, captain2, challenge });
        this.emit(CONSTANTS.EVENT_RUN_LOBBY, lobbyState, [CONSTANTS.STATE_NEW]);
    }

    /**
    * Runs all lobbies for an inhouse.
    * @async
    * @param {module:ihl.inhouseState} inhouseState - The inhouse state.
    * @fires module:ihlManager~EVENT_RUN_LOBBY
    */
    async runLobbiesForInhouse(inhouseState) {
        logger.silly(`ihlManager runLobbiesForInhouse ${inhouseState.guild.id}`);
        const lobbies = await Db.findAllActiveLobbiesForInhouse(inhouseState.guild.id);
        return Fp.allPromise(lobbies.map(lobby => Fp.pipeP(
            Lobby.lobbyToLobbyState(inhouseState),
            Lobby.resetLobbyState,
        )(lobby).then(lobbyState => this.emit(CONSTANTS.EVENT_RUN_LOBBY, lobbyState, [lobbyState.state]))));
    }

    /**
     * Adds a user to a lobby queue.
     * @async
     * @param {module:lobby.LobbyState} lobbyState - The lobby to join.
     * @param {module:db.User} user - The user to queue.
     * @param {external:discordjs.User} discordUser - A discord.js user.
     * @fires module:ihlManager~EVENT_RUN_LOBBY
     */
    async joinLobbyQueue(lobbyState, user, discordUser) {
        logger.silly(`ihlManager joinLobbyQueue ${lobbyState.id} ${user.id} ${discordUser.id}`);
        const result = await Ihl.joinLobbyQueue(user)(lobbyState);
        logger.silly(`ihlManager joinLobbyQueue result ${result}`);
        if (result) {
            this.emit(CONSTANTS.EVENT_RUN_LOBBY, lobbyState, [CONSTANTS.STATE_WAITING_FOR_QUEUE]);
        }
        return result;
    }

    /**
     * Adds a user to all lobby queues.
     * @async
     * @param {module:ihl.InhouseState} inhouseState - The inhouse to queue.
     * @param {module:db.User} user - The user to queue.
     * @param {external:discordjs.User} discordUser - A discord.js user.
     */
    async joinAllLobbyQueues(inhouseState, user, discordUser) {
        logger.silly(`ihlManager joinAllLobbyQueues ${inhouseState.guild.id} ${user.id} ${discordUser.id}`);
        const lobbyStates = await Ihl.getAllLobbyQueues(inhouseState);
        await Fp.allPromise(lobbyStates.map(lobbyState => this.joinLobbyQueue(lobbyState, user, discordUser)));
    }

    /**
     * Removes a user from a lobby queue.
     * @async
     * @param {module:lobby.LobbyState} lobbyState - The lobby to join.
     * @param {module:db.User} user - The user to dequeue.
     * @param {external:discordjs.User} discordUser - A discord.js user.
     * @fires module:ihlManager~EVENT_RUN_LOBBY
     */
    async leaveLobbyQueue(lobbyState, user, discordUser) {
        logger.silly(`ihlManager leaveLobbyQueue ${lobbyState.id} ${user.id} ${discordUser.id}`);
        const inQueue = await Ihl.leaveLobbyQueue(user)(lobbyState);
        if (inQueue) {
            this.emit(CONSTANTS.EVENT_RUN_LOBBY, lobbyState);
        }
        return inQueue;
    }

    /**
     * Removes a user from all lobby queues.
     * @async
     * @param {module:ihl.InhouseState} inhouseState - The inhouse to dequeue.
     * @param {module:db.User} user - The user to dequeue.
     * @param {external:discordjs.User} discordUser - A discord.js user.
     */
    async leaveAllLobbyQueues(inhouseState, user, discordUser) {
        logger.silly(`ihlManager leaveAllLobbyQueues ${inhouseState.guild.id} ${user.id} ${discordUser.id}`);
        const lobbyStates = await Ihl.getAllLobbyQueuesForUser(inhouseState, user);
        await Fp.allPromise(lobbyStates.map(lobbyState => this.leaveLobbyQueue(lobbyState, user, discordUser)));
    }

    /**
     * Clear a lobby queue.
     * @async
     * @param {module:lobby.LobbyState} lobbyState - The lobby queue to clear.
     */
    async clearLobbyQueue(lobbyState) {
        logger.silly(`ihlManager clearLobbyQueue ${lobbyState.id}`);
        await Db.destroyLobbyQueuers(lobbyState);
    }

    /**
     * Clear all lobby queues.
     * @async
     * @param {module:ihl.InhouseState} inhouseState - The inhouse queue to clear.
     */
    async clearAllLobbyQueues(inhouseState) {
        const lobbies = await Db.findAllLobbiesForInhouse(inhouseState);
        logger.silly(`ihlManager clearAllLobbyQueues ${inhouseState.guild.id} ${lobbies.length}`);
        await Fp.mapPromise(Db.destroyLobbyQueuers)(lobbies);
    }

    /**
     * Bans a user from the inhouse queue.
     * @async
     * @param {module:ihl.InhouseState} inhouseState - The inhouse to dequeue.
     * @param {module:db.User} user - The player to ban.
     * @param {number} timeout - Duration of ban in minutes.
     * @param {external:discordjs.User} discordUser - A discord.js user.
     */
    async banInhouseQueue(inhouseState, user, timeout, discordUser) {
        logger.silly(`ihlManager banInhouseQueue ${inhouseState.guild.id} ${user.id} ${timeout} ${discordUser.id}`);
        await Ihl.banInhouseQueue(user, timeout);
        await this.leaveAllLobbyQueues(inhouseState, user, discordUser);
    }

    /**
     * Processes and executes a lobby state if it matches any of the given states.
     * If no states to match against are given, the lobby state is run by default.
     * @async
     * @param {module:lobby.LobbyState} _lobbyState - An inhouse lobby state.
     * @param {string[]} states - A list of valid lobby states.
     */
    async runLobby(_lobbyState, states = []) {
        logger.silly(`ihlManager runLobby ${_lobbyState.id} ${states.join(',')}`);
        let lobbyState;
        try {
            assert.equal(this._runningLobby, false, 'Already running a lobby.');
            this._runningLobby = true;
            const lobby = await Lobby.getLobby(_lobbyState);
            if (!states.length || states.indexOf(lobby.state) !== -1) {
                lobbyState = await Fp.pipeP(
                    Lobby.createLobbyState(_lobbyState.inhouseState)(_lobbyState),
                    Lobby.validateLobbyPlayers,
                )(lobby);
                let beginState = -1;
                let endState = lobbyState.state;
                while (beginState !== endState) {
                    beginState = lobbyState.state;
                    // eslint-disable-next-line no-await-in-loop
                    lobbyState = await this[beginState](lobbyState);
                    endState = lobbyState.state;
                    logger.silly(`runLobby ${lobbyState.id} ${beginState} to ${endState}`);
                    this.emit(beginState, lobbyState); // test hook event
                }
                try {
                    await Lobby.setLobbyTopic(lobbyState);
                }
                catch (e) {
                    logger.error(e);
                }
            }
        }
        catch (e) {
            logger.error(e);
            if (lobbyState) {
                await Db.updateLobbyState(lobbyState)(CONSTANTS.STATE_FAILED);
            }
            process.exit(1);
        }
        finally {
            this._runningLobby = false;
        }
    }

    /**
     * Creates a queue lobby.
     * @async
     * @param {module:lobby.LobbyState} _lobbyState - The lobby state to create the queue from.
     * @fires module:ihlManager~EVENT_RUN_LOBBY
     */
    async onCreateLobbyQueue(_lobbyState) {
        logger.silly(`ihlManager onCreateLobbyQueue ${_lobbyState.id}`);
        const queue = await Db.findQueue(_lobbyState.leagueId, true, _lobbyState.queueType);
        if (queue &amp;&amp; queue.queueType !== CONSTANTS.QUEUE_TYPE_CHALLENGE) {
            logger.silly(`ihlManager onCreateLobbyQueue queue ${queue.queueType}`);
            const lobbyState = await Ihl.createLobby(_lobbyState.inhouseState)(queue);
            await Guild.setChannelPosition(1)(lobbyState.channel);
            this.emit(CONSTANTS.EVENT_RUN_LOBBY, lobbyState, [CONSTANTS.STATE_NEW]);
        }
    }

    /**
     * Sets a lobby state.
     * @async
     * @param {module:lobby.LobbyState} _lobbyState - The lobby state being changed.
     * @param {string} state - The state to set the lobby to.
     * @fires module:ihlManager~EVENT_RUN_LOBBY
     */
    async onSetLobbyState(_lobbyState, state) {
        logger.silly(`ihlManager onSetLobbyState ${_lobbyState.id} ${state}`);
        const lobbyState = { ..._lobbyState, state };
        await Db.updateLobbyState(lobbyState)(state);
        this.emit(CONSTANTS.EVENT_RUN_LOBBY, lobbyState, [state]);
    }

    /**
     * Sets a bot status.
     * @async
     * @param {string} steamId64 - Bot steam id.
     * @param {string} status - Bot status.
     */
    async onSetBotStatus(steamId64, status) {
        logger.silly(`ihlManager onSetBotStatus ${steamId64} ${status}`);
        await Db.updateBot(steamId64)({ status });
    }

    /**
     * Associates a league with a ticket.
     * @async
     * @param {module:db.League} league - The league to add the ticket to.
     * @param {number} leagueid - The ticket league id.
     * @param {string} name - The ticket name.
     */
    async onLeagueTicketAdd(league, leagueid, name) {
        const ticket = await Db.upsertTicket({ leagueid, name });
        logger.silly(`ihlManager onLeagueTicketAdd ${league.id} ${leagueid} ${name} ${util.inspect(ticket)}`);
        if (ticket) {
            await Db.addTicketOf(league)(ticket);
        }
    }

    /**
     * Sets the league ticket.
     * @async
     * @param {module:db.League} league - The league to set the ticket to.
     * @param {number} leagueid - The ticket league id.
     * @returns {module:db.Ticket}
     */
    async onLeagueTicketSet(league, leagueid) {
        const tickets = await Db.getTicketsOf({ where: { leagueid } })(league);
        logger.silly(`ihlManager onLeagueTicketSet ${league.id} ${leagueid} ${util.inspect(tickets)}`);
        if (tickets.length) {
            await Db.updateLeague(league.guildId)({ leagueid });
            return tickets[0];
        }
        return null;
    }

    /**
     * Removes a ticket from a league.
     * @async
     * @param {module:db.League} league - The league to remove the ticket from.
     * @param {number} leagueid - The ticket league id.
     */
    async onLeagueTicketRemove(league, leagueid) {
        const ticket = await Db.findTicketByDotaLeagueId(leagueid);
        logger.silly(`ihlManager onLeagueTicketRemove ${league.id} ${leagueid} ${util.inspect(ticket)}`);
        if (ticket) {
            await Db.removeTicketOf(league)(ticket);
        }
    }

    /**
     * Runs lobbies waiting for bots.
     * @async
     * @fires module:ihlManager~EVENT_RUN_LOBBY
     */
    async onBotAvailable() {
        const lobbies = await Db.findAllLobbiesInState(CONSTANTS.STATE_WAITING_FOR_BOT);
        logger.silly(`ihlManager onBotAvailable ${lobbies.length}`);
        await Fp.allPromise(lobbies.map(lobby => Ihl.loadLobbyState(this.client.guilds)(lobby)
            .then(lobbyState => this.emit(CONSTANTS.EVENT_RUN_LOBBY, lobbyState, [CONSTANTS.STATE_WAITING_FOR_BOT]))));
    }

    /**
     * Creates and registers a ready up timer for a lobby state.
     * @param {module:lobby.LobbyState} lobbyState - An inhouse lobby state.
     * @fires module:ihlManager~MSG_READY_CHECK_START
     */
    registerLobbyTimeout(lobbyState) {
        this.unregisterLobbyTimeout(lobbyState);
        const delay = Math.max(0, lobbyState.readyCheckTime + lobbyState.inhouseState.readyCheckTimeout - Date.now());
        logger.silly(`ihlManager registerLobbyTimeout ${lobbyState.id} ${lobbyState.readyCheckTime} ${lobbyState.inhouseState.readyCheckTimeout}. timeout ${delay}ms`);
        this.lobbyTimeoutTimers[lobbyState.id] = setTimeout(() => {
            logger.silly(`ihlManager registerLobbyTimeout ${lobbyState.id} timed out`);
            this.queueEvent(this.onLobbyTimedOut, [lobbyState]);
        }, delay);
        this.emit(CONSTANTS.MSG_READY_CHECK_START, lobbyState);
    }

    /**
     * Clears and unregisters the ready up timer for a lobby state.
     * @param {module:lobby.LobbyState} lobbyState - An inhouse lobby state.
     */
    unregisterLobbyTimeout(lobbyState) {
        logger.silly(`ihlManager unregisterLobbyTimeout ${lobbyState.id}`);
        if (this.lobbyTimeoutTimers[lobbyState.id]) {
            clearTimeout(this.lobbyTimeoutTimers[lobbyState.id]);
        }
        delete this.lobbyTimeoutTimers[lobbyState.id];
    }

    /**
     * Runs a lobby state when its ready up timer has expired.
     * Checks for STATE_CHECKING_READY lobby state
     * @async
     * @param {module:lobby.LobbyState} lobbyState - An inhouse lobby state.
     * @fires module:ihlManager~EVENT_RUN_LOBBY
     */
    async onLobbyTimedOut(lobbyState) {
        logger.silly(`ihlManager onLobbyTimedOut ${lobbyState.id}`);
        delete this.lobbyTimeoutTimers[lobbyState.id];
        this.emit(CONSTANTS.EVENT_RUN_LOBBY, lobbyState, [CONSTANTS.STATE_CHECKING_READY]);
    }

    /**
     * Runs a lobby state when a player has readied up and update their player ready state.
     * Checks for STATE_CHECKING_READY lobby state
     * @async
     * @param {module:lobby.LobbyState} lobbyState - An inhouse lobby state.
     * @param {module:db.User} user - An inhouse user.
     * @fires module:ihlManager~event:EVENT_PLAYER_READY
     */
    async onPlayerReady(lobbyState, user) {
        logger.silly(`ihlManager onPlayerReady ${lobbyState.id} ${user.id}`);
        await Lobby.setPlayerReady(true)(lobbyState)(user.id);
        this.emit(CONSTANTS.EVENT_RUN_LOBBY, lobbyState, [CONSTANTS.STATE_CHECKING_READY]);
    }

    /**
     * Updates a lobby state with a captain pick selection
     * @async
     * @param {module:lobby.LobbyState} _lobbyState - An inhouse lobby state.
     * @param {module:db.User} captain - The captain user
     * @param {number} pick - The selected pick
     * @fires module:ihlManager~event:EVENT_RUN_LOBBY
     */
    async onSelectionPick(_lobbyState, captain, pick) {
        logger.silly(`ihlManager onSelectionPick ${_lobbyState.id} ${captain.id} ${pick}`);
        const lobby = await Lobby.getLobby(_lobbyState);
        const lobbyState = await Lobby.createLobbyState(_lobbyState.inhouseState)(_lobbyState)(_lobbyState);
        if (lobby.state === CONSTANTS.STATE_SELECTION_PRIORITY &amp;&amp; Lobby.isCaptain(lobbyState)(captain)) {
            if (!lobbyState.playerFirstPick) {
                if (lobbyState[`captain${3 - lobbyState.selectionPriority}UserId`] === captain.id) {
                    lobbyState.playerFirstPick = pick === 1 ? 3 - lobbyState.selectionPriority : lobbyState.selectionPriority;
                    await Db.updateLobby(lobbyState);
                    this.emit(CONSTANTS.EVENT_RUN_LOBBY, lobbyState, [CONSTANTS.STATE_SELECTION_PRIORITY]);
                }
            }
            else if (!lobbyState.firstPick) {
                if (!lobbyState.radiantFaction &amp;&amp; lobbyState[`captain${lobbyState.selectionPriority}UserId`] === captain.id) {
                    lobbyState.firstPick = pick === 1 ? lobbyState.selectionPriority : 3 - lobbyState.selectionPriority;
                    await Db.updateLobby(lobbyState);
                    this.emit(CONSTANTS.EVENT_RUN_LOBBY, lobbyState, [CONSTANTS.STATE_SELECTION_PRIORITY]);
                }
                else if (lobbyState.radiantFaction &amp;&amp; lobbyState[`captain${3 - lobbyState.selectionPriority}UserId`] === captain.id) {
                    lobbyState.firstPick = pick === 1 ? 3 - lobbyState.selectionPriority : lobbyState.selectionPriority;
                    await Db.updateLobby(lobbyState);
                    this.emit(CONSTANTS.EVENT_RUN_LOBBY, lobbyState, [CONSTANTS.STATE_SELECTION_PRIORITY]);
                }
            }
        }
    }

    /**
     * Updates a lobby state with a captain side selection
     * @async
     * @param {module:lobby.LobbyState} _lobbyState - An inhouse lobby state.
     * @param {module:db.User} captain - The captain user
     * @param {number} side - The selected faction
     * @fires module:ihlManager~event:EVENT_RUN_LOBBY
     */
    async onSelectionSide(_lobbyState, captain, side) {
        logger.silly(`ihlManager onSelectionSide ${_lobbyState.id} ${captain.id} ${side}`);
        const lobby = await Lobby.getLobby(_lobbyState);
        const lobbyState = await Lobby.createLobbyState(_lobbyState.inhouseState)(_lobbyState)(_lobbyState);
        if (lobby.state === CONSTANTS.STATE_SELECTION_PRIORITY &amp;&amp; Lobby.isCaptain(lobbyState)(captain)) {
            if (lobbyState.playerFirstPick) {
                if (!lobbyState.radiantFaction) {
                    if (!lobbyState.firstPick &amp;&amp; lobbyState[`captain${lobbyState.selectionPriority}UserId`] === captain.id) {
                        lobbyState.radiantFaction = side === 1 ? lobbyState.selectionPriority : 3 - lobbyState.selectionPriority;
                        await Db.updateLobby(lobbyState);
                        this.emit(CONSTANTS.EVENT_RUN_LOBBY, lobbyState, [CONSTANTS.STATE_SELECTION_PRIORITY]);
                    }
                    else if (lobbyState.firstPick &amp;&amp; lobbyState[`captain${3 - lobbyState.selectionPriority}UserId`] === captain.id) {
                        lobbyState.radiantFaction = side === 1 ? 3 - lobbyState.selectionPriority : lobbyState.selectionPriority;
                        await Db.updateLobby(lobbyState);
                        this.emit(CONSTANTS.EVENT_RUN_LOBBY, lobbyState, [CONSTANTS.STATE_SELECTION_PRIORITY]);
                    }
                }
            }
        }
    }

    /**
     * Checks if a player is draftable and fires an event representing the result.
     * If the player is draftable, checks for STATE_DRAFTING_PLAYERS lobby state and runs the lobby state.
     * @async
     * @param {module:lobby.LobbyState} lobbyState - An inhouse lobby state.
     * @param {module:db.User} user - The picked user
     * @param {number} faction - The picking faction
     * @listens module:ihlManager~event:EVENT_PICK_PLAYER
     * @fires module:ihlManager~event:EVENT_RUN_LOBBY
     */
    async onDraftMember(_lobbyState, captain, user) {
        const lobby = await Lobby.getLobby(_lobbyState);
        const lobbyState = await Lobby.createLobbyState(_lobbyState.inhouseState)(_lobbyState)(_lobbyState);
        const faction = await Lobby.getDraftingFaction(lobbyState.inhouseState.draftOrder)(lobbyState);
        logger.silly(`ihlManager onDraftMember ${lobbyState.id} ${lobby.state} ${faction} ${captain.id} ${Lobby.isFactionCaptain(lobbyState)(faction)(captain)}`);
        if (lobby.state === CONSTANTS.STATE_DRAFTING_PLAYERS &amp;&amp; Lobby.isFactionCaptain(lobbyState)(faction)(captain)) {
            const player = await Lobby.getPlayerByUserId(lobbyState)(user.id);
            if (player) {
                const result = await Lobby.isPlayerDraftable(lobbyState)(player);
                logger.silly(`ihlManager onDraftMember draftable ${result}`);
                if (result === CONSTANTS.PLAYER_DRAFTED) {
                    await Lobby.setPlayerFaction(faction)(lobbyState)(user.id);
                    this.emit(CONSTANTS.EVENT_RUN_LOBBY, lobbyState, [CONSTANTS.STATE_DRAFTING_PLAYERS]);
                }
                return result;
            }
            return CONSTANTS.INVALID_PLAYER_NOT_FOUND;
        }
        return null;
    }

    /**
     * Force lobby into player draft with assigned captains.
     * @async
     * @param {module:lobby.LobbyState} lobbyState - An inhouse lobby state.
     * @param {module:db.User} captain1 - The captain 1 user
     * @param {module:db.User} captain2 - The captain 2 user
     * @fires module:ihlManager~event:EVENT_RUN_LOBBY
     */
    async onforceLobbyDraft(lobbyState, captain1, captain2) {
        logger.silly(`ihlManager onforceLobbyDraft ${captain1.id} ${captain2.id}`);
        if (lobbyState.botId) {
            await this.botLeaveLobby(lobbyState);
            await Lobby.unassignBotFromLobby(lobbyState);
        }
        await Lobby.forceLobbyDraft(lobbyState, captain1, captain2);
        await Db.updateLobby(lobbyState);
        this.emit(CONSTANTS.EVENT_RUN_LOBBY, lobbyState);
    }

    /**
     * Kicks a player from the dota lobby.
     * @async
     * @param {module:lobby.LobbyState} lobbyState - An inhouse lobby state.
     * @param {module:db.User} user - The player to kick
     */
    async onLobbyKick(lobbyState, user) {
        logger.silly(`ihlManager onLobbyKick ${lobbyState.id} ${user.id} ${lobbyState.botId} ${user.steamId64}`);
        const dotaBot = this.getBot(lobbyState.botId);
        if (dotaBot) {
            DotaBot.kickPlayer(dotaBot)(user);
        }
    }

    /**
     * Invites a player to the dota lobby.
     * @async
     * @param {module:lobby.LobbyState} lobbyState - An inhouse lobby state.
     * @param {module:db.User} user - The player to invite
     */
    async onLobbyInvite(lobbyState, user) {
        logger.silly(`ihlManager onLobbyInvite ${lobbyState.id} ${user.id} ${lobbyState.botId} ${user.steamId64}`);
        const dotaBot = this.getBot(lobbyState.botId);
        if (dotaBot) {
            DotaBot.invitePlayer(dotaBot)(user);
        }
    }

    /**
     * Runs a lobby state when the lobby is ready (all players have joined and are in the right team slot).
     * Checks for STATE_WAITING_FOR_PLAYERS lobby state
     * @async
     * @param {string} dotaLobbyId - A dota lobby id.
     * @fires module:ihlManager~event:EVENT_RUN_LOBBY
     */
    async onLobbyReady(dotaLobbyId) {
        const lobby = await Db.findLobbyByDotaLobbyId(dotaLobbyId);
        logger.silly(`ihlManager onLobbyReady ${dotaLobbyId} ${lobby.id}`);
        this.emit(CONSTANTS.EVENT_RUN_LOBBY, lobby, [CONSTANTS.STATE_WAITING_FOR_PLAYERS]);
    }

    /**
     * Puts a lobby state in STATE_PENDING_KILL and runs lobby.
     * @async
     * @param {module:lobby.LobbyState} lobbyState - An inhouse lobby state.
     * @fires module:ihlManager~event:EVENT_RUN_LOBBY
     */
    async onLobbyKill(lobbyState) {
        logger.silly(`ihlManager onLobbyKill ${lobbyState.id}`);
        await Db.updateLobbyState(lobbyState)(CONSTANTS.STATE_PENDING_KILL);
        this.emit(CONSTANTS.EVENT_RUN_LOBBY, lobbyState, [CONSTANTS.STATE_PENDING_KILL]);
    }

    /**
     * Handles match signed out bot event.
     * Updates STATE_MATCH_IN_PROGRESS lobby state to STATE_MATCH_ENDED
     * @async
     * @param {number} matchId - A dota match id.
     * @fires module:ihlManager~event:EVENT_RUN_LOBBY
     */
    async onMatchSignedOut(matchId) {
        const lobbyState = await Ihl.loadLobbyStateFromMatchId(this.client.guilds)(matchId.toString());
        logger.silly(`ihlManager onMatchSignedOut ${matchId} ${lobbyState.id} ${lobbyState.state}`);
        if (lobbyState.state === CONSTANTS.STATE_MATCH_IN_PROGRESS) {
            await Db.updateLobbyState(lobbyState)(CONSTANTS.STATE_MATCH_ENDED);
            logger.silly('ihlManager onMatchSignedOut state set to STATE_MATCH_ENDED');
            this.emit(CONSTANTS.EVENT_RUN_LOBBY, lobbyState, [CONSTANTS.STATE_MATCH_ENDED]);
        }
        await this.botLeaveLobby(lobbyState);
        await Lobby.unassignBotFromLobby(lobbyState);
    }

    /**
     * Handles match outcome bot event.
     * Updates lobby winner and player stats.
     * Sends match stats message.
     * Puts lobby into STATE_MATCH_STATS state
     * @async
     * @param {string} dotaLobbyId - A dota lobby id.
     * @param {external:Dota2.schema.EMatchOutcome} matchOutcome - The dota match outcome
     * @param {external:Dota2.schema.CDOTALobbyMember[]} members - Array of dota lobby members
     * @fires module:ihlManager~event:MSG_MATCH_STATS
     * @fires module:ihlManager~event:EVENT_RUN_LOBBY
     */
    async onMatchOutcome(dotaLobbyId, matchOutcome, members) {
        const lobbyState = await Ihl.loadLobbyStateFromDotaLobbyId(this.client.guilds)(dotaLobbyId);
        logger.silly(`ihlManager onMatchOutcome ${dotaLobbyId} ${matchOutcome} ${lobbyState.id}`);
        await setMatchPlayerDetails(matchOutcome)(members)(lobbyState);
        this.emit(CONSTANTS.MSG_MATCH_STATS, lobbyState, lobbyState.inhouseState);
        await Db.updateLobbyState(lobbyState)(CONSTANTS.STATE_MATCH_STATS);
        this.emit(CONSTANTS.EVENT_RUN_LOBBY, lobbyState, [CONSTANTS.STATE_MATCH_STATS]);
    }

    /**
     * Handles match tracker match stats event.
     * Sends match stats message.
     * Puts lobby into STATE_MATCH_STATS state
     * @async
     * @param {module:db.Lobby} lobby - A lobby database model
     * @fires module:ihlManager~event:MSG_MATCH_STATS
     * @fires module:ihlManager~event:EVENT_RUN_LOBBY
     */
    async onMatchStats(lobby) {
        logger.silly(`ihlManager onMatchStats ${lobby.id}`);
        const league = await Db.findLeagueById(lobby.leagueId);
        const inhouseState = await Ihl.createInhouseState({ league, guild: this.client.guilds.get(league.guildId) });
        const lobbyState = await Lobby.lobbyToLobbyState(inhouseState)(lobby);
        this.emit(CONSTANTS.MSG_MATCH_STATS, lobbyState, inhouseState);
        await Db.updateLobbyState(lobbyState)(CONSTANTS.STATE_MATCH_STATS);
        this.emit(CONSTANTS.EVENT_RUN_LOBBY, lobbyState, [CONSTANTS.STATE_MATCH_STATS]);
    }

    /**
     * Handles match tracker match no stats event.
     * Sends match no stats message.
     * Puts lobby into STATE_MATCH_NO_STATS state
     * @async
     * @param {module:db.Lobby} lobby - A lobby database model
     * @fires module:ihlManager~event:MSG_MATCH_NO_STATS
     * @fires module:ihlManager~event:EVENT_RUN_LOBBY
     */
    async onMatchNoStats(lobby) {
        logger.silly(`ihlManager onMatchNoStats ${lobby.id}`);
        const league = await Db.findLeagueById(lobby.leagueId);
        const inhouseState = await Ihl.createInhouseState({ league, guild: this.client.guilds.get(league.guildId) });
        const lobbyState = await Lobby.lobbyToLobbyState(inhouseState)(lobby);
        this.emit(CONSTANTS.MSG_MATCH_NO_STATS, lobbyState, inhouseState);
        await Db.updateLobbyState(lobbyState)(CONSTANTS.STATE_MATCH_NO_STATS);
        this.emit(CONSTANTS.EVENT_RUN_LOBBY, lobbyState, [CONSTANTS.STATE_MATCH_NO_STATS]);
    }

    /**
     * Processes the inhouse manager event queue until it is empty.
     * Events are actions to perform (mostly on lobby states or something that resolves to a lobby state).
     * An event consists of a function, the arguments to call it with,
     * and the resolve and reject callbacks of the Promise wrapping the action.
     * When the action is executed, resolve with the returned value
     * or reject if an error was thrown.
     * The queue blocks while processing an action, so only 1 can be processed at a time.
     * @async
     * @fires module:ihlManager~event:empty
     */
    async processEventQueue() {
        if (this.blocking) return;
        if (this.eventQueue.length) {
            this.blocking = true;
            const [fn, args, resolve, reject] = this.eventQueue.shift();
            logger.silly(`ihlManager processEventQueue ${fn.name} ${this.eventQueue.length}`);
            try {
                const value = await fn.apply(this, args);
                resolve(value);
            }
            catch (e) {
                logger.error(e);
                reject(e);
            }
            this.blocking = false;
            if (this.eventQueue.length) {
                await this.processEventQueue();
            }
            else {
                this.emit('empty'); // test hook event
            }
        }
    }

    /**
     * Callback for a lobby processing event.
     *
     * @callback eventCallback
     */

    /**
     * Adds a lobby processing function and its arguments to the queue.
     * When the queue is processed the function will be executed with its arguments.
     * @async
     * @param {eventCallback} fn - A lobby processing event function.
     * @param {...*} args - A list of arguments the lobby processing event function will be called with.
     */
    async queueEvent(fn, args = []) {
        logger.silly(`ihlManager queueEvent ${fn.name} ${args}`);
        return new Promise((resolve, reject) => {
            this.eventQueue.push([fn, args, resolve, reject]);
            this.processEventQueue().catch(e => logger.error(e) &amp;&amp; process.exit(1));
        });
    }

    /**
     * Gets a bot.
     * @param {number} botId - The bot id.
     * @returns {module:dotaBot.DotaBot}
     */
    getBot(botId) {
        logger.silly(`ihlManager getBot ${botId}`);
        return botId != null ? this.bots[botId] : null;
    }

    /**
     * Start a dota bot.
     * @async
     * @param {number} botId - The bot id.
     * @returns {module:dotaBot.DotaBot}
     */
    async loadBot(botId) {
        logger.silly(`ihlManager loadBot ${botId}`);
        let dotaBot = this.getBot(botId);
        if (!dotaBot) {
            await Db.updateBotStatus(CONSTANTS.BOT_LOADING)(botId);
            try {
                dotaBot = await Fp.pipeP(
                    Db.findBot,
                    DotaBot.createDotaBot,
                    DotaBot.connectDotaBot,
                )(botId);
                dotaBot.on(CONSTANTS.MSG_CHAT_MESSAGE, (channel, senderName, message, chatData) => this.emit(CONSTANTS.MSG_CHAT_MESSAGE, dotaBot.dotaLobbyId.toString(), channel, senderName, message, chatData));
                dotaBot.on(CONSTANTS.MSG_LOBBY_PLAYER_JOINED, member => this.emit(CONSTANTS.MSG_LOBBY_PLAYER_JOINED, dotaBot.dotaLobbyId.toString(), member));
                dotaBot.on(CONSTANTS.MSG_LOBBY_PLAYER_LEFT, member => this.emit(CONSTANTS.MSG_LOBBY_PLAYER_LEFT, dotaBot.dotaLobbyId.toString(), member));
                dotaBot.on(CONSTANTS.MSG_LOBBY_PLAYER_CHANGED_SLOT, state => this.emit(CONSTANTS.MSG_LOBBY_PLAYER_CHANGED_SLOT, dotaBot.dotaLobbyId.toString(), state));
                dotaBot.on(CONSTANTS.EVENT_LOBBY_READY, () => this.emit(CONSTANTS.EVENT_LOBBY_READY, dotaBot.dotaLobbyId.toString()));
                dotaBot.on(CONSTANTS.EVENT_MATCH_SIGNEDOUT, matchId => this.emit(CONSTANTS.EVENT_MATCH_SIGNEDOUT, matchId));
                dotaBot.on(CONSTANTS.EVENT_MATCH_OUTCOME, (dotaLobbyId, matchOutcome, members) => this.emit(CONSTANTS.EVENT_MATCH_OUTCOME, dotaLobbyId.toString(), matchOutcome, members));
                this.bots[botId] = dotaBot;
                logger.silly('ihlManager loadBot loaded');
            }
            catch (e) {
                logger.error(e);
                await Db.updateBotStatus(CONSTANTS.BOT_FAILED)(botId);
                return null;
            }
        }
        logger.silly('ihlManager loadBot done');
        return dotaBot;
    }

    /**
     * Remove a dota bot.
     * @async
     * @param {number} botId - The bot id.
     */
    async removeBot(botId) {
        logger.silly(`ihlManager removeBot ${botId}`);
        const dotaBot = this.get(botId);
        if (dotaBot) {
            try {
                delete this.bots[botId];
                await DotaBot.disconnectDotaBot(dotaBot);
                logger.silly('ihlManager removeBot removed');
            }
            catch (e) {
                logger.error(e);
                await Db.updateBotStatus(CONSTANTS.BOT_FAILED)(botId);
            }
        }
    }

    /**
     * Disconnect a dota bot from its lobby.
     * @param {module:lobby.lobbyState} lobbyState - The lobby for the bot.
     * @fires module:ihlManager~event:EVENT_RUN_LOBBY
     */
    async botLeaveLobby(lobbyState) {
        logger.silly(`ihlManager botLeaveLobby ${lobbyState.id}`);
        const dotaBot = this.getBot(lobbyState.botId);
        if (dotaBot) {
            if (equalsLong(lobbyState.dotaLobbyId, dotaBot.dotaLobbyId)) {
                await dotaBot.leavePracticeLobby();
                await dotaBot.abandonCurrentGame();
                await Db.updateBotStatus(CONSTANTS.BOT_IDLE)(lobbyState.botId);
                logger.silly(`ihlManager botLeaveLobby bot ${lobbyState.botId} left lobby ${lobbyState.dotaLobbyId}`);
                const lobbyStates = await Fp.mapPromise(Ihl.loadLobbyState(this.client.guilds))(Db.findAllLobbiesInState(CONSTANTS.STATE_WAITING_FOR_BOT));
                for (const _lobbyState of lobbyStates) {
                    this.emit(CONSTANTS.EVENT_RUN_LOBBY, _lobbyState, [CONSTANTS.STATE_WAITING_FOR_BOT]);
                }
            }
        }
    }

    /**
     * Start a dota lobby if all players are in the lobby and on the correct teams.
     * @param {module:lobby.lobbyState} _lobbyState - The lobby state to check.
     * @param {module:lobby.lobbyState} _dotaBot - The bot to check.
     * @fires module:ihlManager~event:MSG_LOBBY_STARTED
     * @returns {module:lobby.lobbyState}
     */
    async onStartDotaLobby(_lobbyState, _dotaBot) {
        const lobbyState = { ..._lobbyState };
        logger.silly(`ihlManager onStartDotaLobby ${lobbyState.id} ${lobbyState.botId} ${lobbyState.state}`);
        if (lobbyState.state !== CONSTANTS.STATE_WAITING_FOR_PLAYERS) return false;
        const dotaBot = _dotaBot || this.getBot(lobbyState.botId);
        if (dotaBot) {
            lobbyState.state = CONSTANTS.STATE_MATCH_IN_PROGRESS;
            lobbyState.startedAt = Date.now();
            lobbyState.matchId = await DotaBot.startDotaLobby(dotaBot);
            logger.silly(`ihlManager onStartDotaLobby matchId ${lobbyState.matchId} leagueid ${lobbyState.leagueid}`);
            if (lobbyState.leagueid) {
                await this.botLeaveLobby(lobbyState);
            }
            await Lobby.removeQueuers(lobbyState);
            await Db.updateLobby(lobbyState);
            this.matchTracker.addLobby(lobbyState);
            this.matchTracker.run();
            this.emit(CONSTANTS.MSG_LOBBY_STARTED, lobbyState);
            logger.silly('ihlManager onStartDotaLobby true');
        }
        logger.silly('ihlManager onStartDotaLobby false');
        return lobbyState;
    }

    /**
     * Bind all events to their corresponding event handler functions
     */
    attachListeners() {
        for (const eventName of Object.keys(CONSTANTS)) {
            if (eventName.startsWith('EVENT_') || eventName.startsWith('MSG_')) {
                this.on(CONSTANTS[eventName], this[eventName].bind(this));
            }
        }
    }
}
Object.assign(IHLManager.prototype, LobbyStateHandlers.LobbyStateHandlers({ DotaBot, Db, Guild, Lobby, MatchTracker, LobbyQueueHandlers }));
Object.assign(IHLManager.prototype, EventListeners({ Db }));
Object.assign(IHLManager.prototype, MessageListeners({ Db, Guild, Lobby, MatchTracker, Ihl }));

/**
 * IHLManager ready event.
 *
 * @event module:ihlManager~ready
 */

/**
 * IHLManager event queue empty event.
 *
 * @event module:ihlManager~empty
 */

/**
 * Event indicating a message was sent to the guild.
 *
 * @event module:ihlManager~EVENT_GUILD_MESSAGE
 * @param {external:discordjs.Message} msg - A discord.js guild message.
 */

/**
 * Event indicating an inhouse user has left the guild.
 *
 * @event module:ihlManager~EVENT_GUILD_USER_LEFT
 * @param {external:db.User} user - An inhouse user.
 */

/**
 * Event for running a lobby.
 *
 * @event module:ihlManager~EVENT_RUN_LOBBY
 * @param {module:lobby.LobbyState} lobbyState - The lobby to run.
 * @param {string[]} states - A list of valid lobby states.
 */

/**
 * Event setting lobby into a player draft state.
 *
 * @event module:ihlManager~EVENT_LOBBY_FORCE_DRAFT
 * @param {module:lobby.LobbyState} lobbyState - An inhouse lobby state.
 * @param {module:db.User} captain1 - The captain 1 user
 * @param {module:db.User} captain2 - The captain 2 user
 */

/**
 * Event reporting that a player has readied up.
 *
 * @event module:ihlManager~EVENT_PLAYER_READY
 * @param {module:lobby.LobbyState} lobbyState - An inhouse lobby state.
 * @param {module:db.User} user - The picked user
 */

/**
 * Event reporting that a player has been picked.
 *
 * @event module:ihlManager~EVENT_PICK_PLAYER
 * @param {module:lobby.LobbyState} lobbyState - An inhouse lobby state.
 * @param {module:db.User} user - The picked user
 * @param {number} faction - The picking faction
 */

module.exports = {
    findUser,
    loadInhouseStates,
    loadInhouseStatesFromLeagues,
    createClient,
    setMatchPlayerDetails,
    IHLManager,
};
</code></pre>
        </article>
    </section>




</div>

<footer>
    <img class="logo" src="img/toast-ui.png" style="">
    <div class="footer-text">https://github.com/devilesk/dota-ihl-bot</div>
</footer>
<script>prettyPrint();</script>
<script src="scripts/jquery.min.js"></script>
<script src="scripts/tui-doc.js"></script>
<script src="scripts/linenumber.js"></script>

    <script>
        var id = '_sub'.replace(/"/g, '_');
        var selectedApi = document.getElementById(id); // do not use jquery selector
        var $selectedApi = $(selectedApi);

        $selectedApi.removeClass('hidden');
        $selectedApi.parent().find('.glyphicon').removeClass('glyphicon-plus').addClass('glyphicon-minus');
        showLnbApi();
    </script>

</body>
</html>
